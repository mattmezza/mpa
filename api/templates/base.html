<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Agent Admin{% endblock %}</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
  {% block head %}{% endblock %}
</head>
<body class="py-8" style="padding-left: 32px; padding-right: 32px;">
  {% block body %}{% endblock %}

  <div id="toast" style="position: fixed; right: 24px; bottom: 24px; display: none; z-index: 100; max-width: 360px;"></div>

  <script>
    // Global: set HTMX auth header from localStorage
    document.body.addEventListener('htmx:configRequest', function(e) {
      const key = localStorage.getItem('admin_api_key') || '';
      if (key) {
        e.detail.headers['Authorization'] = 'Bearer ' + key;
      }
    });

    document.body.addEventListener('htmx:afterSwap', function(e) {
      if (window.Alpine && e.detail && e.detail.target) {
        window.Alpine.initTree(e.detail.target);
      }
    });

    function showToast(message, ok = true) {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.textContent = message;
      toast.className = ok ? 'alert-success' : 'alert-error';
      toast.style.display = 'block';
      clearTimeout(toast._timer);
      toast._timer = setTimeout(() => {
        toast.style.display = 'none';
      }, 2500);
    }
    window.showToast = showToast;

    function llmTab(apiKey, model) {
      return {
        apiKey: apiKey || '',
        model: model || '',
        result: '',
        resultOk: false,
        testing: false,
        testResult: ''
      };
    }
    window.llmTab = llmTab;

    function searchTab(enabled, provider, apiKey, maxResults) {
      return {
        enabled: enabled ?? 'false',
        provider: provider || 'tavily',
        apiKey: apiKey || '',
        maxResults: maxResults || '5',
        result: '',
        resultOk: false,
        testing: false,
        testResult: ''
      };
    }
    window.searchTab = searchTab;

    function calendarTab(providers) {
      const list = Array.isArray(providers) ? providers : [];
      return {
        providers: list.map((p, idx) => ({
          id: p.id || String(Date.now() + idx),
          name: p.name || '',
          url: p.url || '',
          username: p.username || '',
          password: p.password || ''
        })),
        status: '',
        result: '',
        ok: false,
        addProvider() {
          this.providers.push({
            id: String(Date.now() + Math.random()),
            name: '',
            url: '',
            username: '',
            password: ''
          });
        },
        removeProvider(index) {
          this.providers.splice(index, 1);
        },
        saveProviders() {
          this.status = 'Saving...';
          const cleaned = this.providers
            .map(p => ({
              name: (p.name || '').trim(),
              url: (p.url || '').trim(),
              username: (p.username || '').trim(),
              password: (p.password || '').trim()
            }))
            .filter(p => p.name || p.url || p.username || p.password);
          const url = new URL('/calendar/providers', window.location.origin);
          fetch(url.toString(), {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
            },
            credentials: 'same-origin',
            body: JSON.stringify({providers: cleaned})
          })
            .then(async r => {
              const text = await r.text();
              let data = {};
              try {
                data = text ? JSON.parse(text) : {};
              } catch (err) {
                data = {error: text || 'Invalid response'};
              }
              return {ok: r.ok, data};
            })
            .then(({ok, data}) => {
              this.ok = ok && data.ok;
              this.result = this.ok ? 'Calendars saved' : (data.error || 'Save failed');
              this.status = '';
              if (this.ok && window.showToast) { window.showToast('Calendars saved'); }
            })
            .catch(e => {
              this.ok = false;
              this.result = e.message || 'Network error';
              this.status = '';
            });
        }
      };
    }
    window.calendarTab = calendarTab;

    function emailTab(toml) {
      return {
        toml: toml || '',
        result: '',
        resultOk: false,
        save() {
          fetch('/config', {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
            },
            body: JSON.stringify({values: {'email.himalaya.toml': this.toml}})
          })
            .then(r => { this.resultOk = r.ok; return r.json(); })
            .then(d => {
              this.result = this.resultOk ? 'Email config saved' : (d.detail || 'Error');
              if (this.resultOk && window.showToast) { window.showToast('Email config saved'); }
            })
            .catch(e => { this.resultOk = false; this.result = e.message; });
        }
      };
    }
    window.emailTab = emailTab;

    // Global: handle 401 by redirecting to auth gate
    document.body.addEventListener('htmx:responseError', function(e) {
      if (e.detail.xhr.status === 401) {
        window.location.href = '/login';
      }
    });
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>
