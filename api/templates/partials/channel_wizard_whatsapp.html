<div>
  <div class="flex items-start justify-between gap-3 flex-wrap">
    <div>
      <h3 class="text-base mb-1">WhatsApp setup</h3>
      <p class="text-xs text-muted">Connect your WhatsApp bridge and restrict who can message the agent.</p>
    </div>
    <div class="badge-off">Bridge required</div>
  </div>

  <div class="grid grid-cols-1 gap-3 mt-3">
    <div class="card" style="padding: 0.75rem;">
      <div class="text-xs text-muted uppercase tracking-wider">Step 1</div>
      <div class="text-xs mt-1">Run your WhatsApp bridge service (Node sidecar) and keep it online.</div>
    </div>
    <div class="card" style="padding: 0.75rem;">
      <div class="text-xs text-muted uppercase tracking-wider">Step 2</div>
      <div class="text-xs mt-1">Paste the bridge URL and choose which numbers can reach the agent.</div>
    </div>
    <div class="card" style="padding: 0.75rem;">
      <div class="text-xs text-muted uppercase tracking-wider">Step 3</div>
      <div class="text-xs mt-1">
        Set the bridge webhook to <code id="wa-webhook-url" class="px-1.5 py-0.5 bg-surface-active rounded text-accent text-[0.7rem]">/webhook/whatsapp</code>
        on this server.
      </div>
    </div>
  </div>

  <div class="mt-3">
    <label class="label" for="ch-wa-bridge">Bridge URL</label>
    <input type="text" class="input" id="ch-wa-bridge" placeholder="http://localhost:3001"
           value="{{ bridge_url|default('http://localhost:3001') }}">
    <div class="hint">Must be reachable from this server. Example: http://192.168.1.10:3001</div>
  </div>

  <div class="mt-3">
    <label class="label" for="ch-wa-token">Bridge token (optional)</label>
    <input type="password" class="input" id="ch-wa-token" placeholder="shared secret"
           value="{{ bridge_token|default('') }}">
    <div class="hint">Optional shared secret. Must match the bridge's token.</div>
  </div>

  <div class="mt-3">
    <label class="label" for="ch-wa-numbers">Allowed numbers</label>
    <input type="text" class="input" id="ch-wa-numbers" placeholder="+14155551234, +442071838750"
           value="{{ allowed_numbers|default('') }}">
    <div class="hint">Comma-separated international numbers. Leave empty to allow any sender.</div>
  </div>

  <div class="mt-3">
    <label class="label" for="ch-wa-enabled">Channel status</label>
    <div class="flex items-center gap-2 text-xs">
      <input type="checkbox" id="ch-wa-enabled" class="input-sm" style="width: auto;"
             {% if enabled|default('true') == 'true' %}checked{% endif %}>
      <span>Enable WhatsApp channel</span>
    </div>
  </div>

  <div class="flex items-center gap-2 mt-4">
    <button class="btn btn-sm" type="button" onclick="testWhatsApp()">Test bridge</button>
    <button class="btn btn-sm" type="button" onclick="startWhatsAppBridge()">Start auth</button>
    <button class="btn btn-sm" type="button" onclick="stopWhatsAppBridge()">Stop auth</button>
    <button class="btn btn-sm" type="button" onclick="logoutWhatsAppBridge()">Logout + wipe</button>
    <button class="btn-primary btn-sm" type="button" onclick="saveWhatsApp()">Save</button>
  </div>
  <div id="channel-wizard-result" class="mt-2 text-xs"></div>
  <div id="wa-auth-panel" class="mt-3" style="display: none;">
    <div class="text-xs text-muted uppercase tracking-wider">WhatsApp auth</div>
    <div class="text-xs mt-1 text-muted">Scan the QR code to link your WhatsApp account.</div>
    <div class="mt-2" id="wa-auth-qr"></div>
  </div>
</div>

<script>
  (function setWebhookUrl() {
    const el = document.getElementById('wa-webhook-url');
    if (!el) return;
    try {
      el.textContent = window.location.origin + '/webhook/whatsapp';
    } catch (e) {
      el.textContent = '/webhook/whatsapp';
    }
  })();

  function saveWhatsApp() {
    const result = document.getElementById('channel-wizard-result');
    const bridgeUrl = document.getElementById('ch-wa-bridge').value.trim();
    const bridgeToken = document.getElementById('ch-wa-token').value.trim();
    const numbers = document.getElementById('ch-wa-numbers').value.trim();
    const enabled = document.getElementById('ch-wa-enabled').checked;
    if (!bridgeUrl) {
      result.textContent = 'Bridge URL is required.';
      result.className = 'alert-error';
      return;
    }
    fetch('/channels/whatsapp', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
      },
      body: JSON.stringify({bridge_url: bridgeUrl, bridge_token: bridgeToken, allowed_numbers: numbers, enabled: enabled})
    })
      .then(r => r.text())
      .then(html => {
        document.getElementById('tab-content').innerHTML = html;
        closeChannelWizard();
        if (window.showToast) { window.showToast('WhatsApp channel saved'); }
      })
      .catch(e => {
        result.textContent = e.message;
        result.className = 'alert-error';
      });
  }

  function testWhatsApp() {
    const result = document.getElementById('channel-wizard-result');
    const bridgeUrl = document.getElementById('ch-wa-bridge').value.trim();
    const bridgeToken = document.getElementById('ch-wa-token').value.trim();
    if (!bridgeUrl) {
      result.textContent = 'Bridge URL is required.';
      result.className = 'alert-error';
      return;
    }
    result.textContent = 'Testing bridge...';
    result.className = 'alert-info';
    fetch('/channels/whatsapp/test', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
      },
      body: JSON.stringify({ bridge_url: bridgeUrl, bridge_token: bridgeToken })
    })
      .then(r => r.json())
      .then(d => {
        const ok = d && d.ok === true;
        result.textContent = ok ? 'Bridge is reachable.' : (d.error || 'Bridge not reachable.');
        result.className = ok ? 'alert-success' : 'alert-error';
      })
      .catch(e => {
        result.textContent = e.message || 'Bridge not reachable.';
        result.className = 'alert-error';
      });
  }

  async function startWhatsAppBridge() {
    const result = document.getElementById('channel-wizard-result');
    result.textContent = 'Starting WhatsApp bridge...';
    result.className = 'alert-info';
    try {
      const bridgeUrl = document.getElementById('ch-wa-bridge').value.trim().replace(/\/$/, '');
      if (!bridgeUrl) {
        result.textContent = 'Bridge URL is required.';
        result.className = 'alert-error';
        return;
      }
      const r = await fetch(bridgeUrl + '/auth/start', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-WA-Bridge-Token': document.getElementById('ch-wa-token').value.trim()
        }
      });
      if (!r.ok) {
        throw new Error('Bridge start failed');
      }
      await pollWhatsAppAuth();
    } catch (e) {
      result.textContent = e.message || 'Bridge start failed.';
      result.className = 'alert-error';
    }
  }

  async function stopWhatsAppBridge() {
    const result = document.getElementById('channel-wizard-result');
    result.textContent = 'Stopping WhatsApp bridge...';
    result.className = 'alert-info';
    try {
      const bridgeUrl = document.getElementById('ch-wa-bridge').value.trim().replace(/\/$/, '');
      if (!bridgeUrl) {
        result.textContent = 'Bridge URL is required.';
        result.className = 'alert-error';
        return;
      }
      const r = await fetch(bridgeUrl + '/auth/stop', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-WA-Bridge-Token': document.getElementById('ch-wa-token').value.trim()
        }
      });
      if (!r.ok) {
        throw new Error('Bridge stop failed');
      }
      const panel = document.getElementById('wa-auth-panel');
      const qrBox = document.getElementById('wa-auth-qr');
      if (panel) panel.style.display = 'none';
      if (qrBox) qrBox.textContent = '';
      result.textContent = 'WhatsApp auth stopped.';
      result.className = 'alert-success';
    } catch (e) {
      result.textContent = e.message || 'Bridge stop failed.';
      result.className = 'alert-error';
    }
  }

  async function logoutWhatsAppBridge() {
    const result = document.getElementById('channel-wizard-result');
    result.textContent = 'Logging out WhatsApp auth...';
    result.className = 'alert-info';
    try {
      const bridgeUrl = document.getElementById('ch-wa-bridge').value.trim().replace(/\/$/, '');
      if (!bridgeUrl) {
        result.textContent = 'Bridge URL is required.';
        result.className = 'alert-error';
        return;
      }
      const r = await fetch(bridgeUrl + '/auth/logout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-WA-Bridge-Token': document.getElementById('ch-wa-token').value.trim()
        }
      });
      if (!r.ok) {
        throw new Error('Logout failed');
      }
      const panel = document.getElementById('wa-auth-panel');
      const qrBox = document.getElementById('wa-auth-qr');
      if (panel) panel.style.display = 'none';
      if (qrBox) qrBox.textContent = '';
      result.textContent = 'WhatsApp auth cleared.';
      result.className = 'alert-success';
    } catch (e) {
      result.textContent = e.message || 'Logout failed.';
      result.className = 'alert-error';
    }
  }

  async function pollWhatsAppAuth() {
    const result = document.getElementById('channel-wizard-result');
    const panel = document.getElementById('wa-auth-panel');
    const qrBox = document.getElementById('wa-auth-qr');
    let attempts = 0;
    const maxAttempts = 60;

    const tick = async () => {
      attempts += 1;
      if (attempts > maxAttempts) {
        result.textContent = 'QR timed out. Try starting the bridge again.';
        result.className = 'alert-error';
        return;
      }
      try {
        const bridgeUrl = document.getElementById('ch-wa-bridge').value.trim().replace(/\/$/, '');
        const r = await fetch(bridgeUrl + '/auth/status', {
          headers: { 'X-WA-Bridge-Token': document.getElementById('ch-wa-token').value.trim() }
        });
        const status = await r.json();
        if (status.started === false) {
          panel.style.display = 'none';
          result.textContent = 'Auth not started. Click "Start auth" to begin.';
          result.className = 'alert-info';
          return;
        }
        if (status.authenticated) {
          panel.style.display = 'none';
          result.textContent = 'WhatsApp authenticated.';
          result.className = 'alert-success';
          return;
        }
        panel.style.display = 'block';
        if (status.data_url || status.qr_data_url) {
          const dataUrl = status.data_url || status.qr_data_url;
          qrBox.innerHTML = '<img src="' + dataUrl + '" alt="WhatsApp QR" style="max-width: 280px;" />';
        } else {
          qrBox.textContent = 'Waiting for QR...';
        }
      } catch (e) {
        result.textContent = e.message || 'Failed to fetch auth status.';
        result.className = 'alert-error';
      }
      setTimeout(tick, 2000);
    };

    tick();
  }

  async function refreshWhatsAppAuth() {
    const result = document.getElementById('channel-wizard-result');
    const panel = document.getElementById('wa-auth-panel');
    const qrBox = document.getElementById('wa-auth-qr');
    try {
      const bridgeUrl = document.getElementById('ch-wa-bridge').value.trim().replace(/\/$/, '');
      if (!bridgeUrl) return;
      const r = await fetch(bridgeUrl + '/auth/status', {
        headers: { 'X-WA-Bridge-Token': document.getElementById('ch-wa-token').value.trim() }
      });
      const status = await r.json();
      if (status.authenticated) {
        panel.style.display = 'none';
        result.textContent = 'WhatsApp already authenticated.';
        result.className = 'alert-success';
        return;
      }
      if (status.started) {
        panel.style.display = 'block';
        if (status.data_url) {
          qrBox.innerHTML = '<img src="' + status.data_url + '" alt="WhatsApp QR" style="max-width: 280px;" />';
        } else {
          qrBox.textContent = 'Waiting for QR...';
        }
        result.textContent = 'Waiting for WhatsApp QR...';
        result.className = 'alert-info';
      }
    } catch (e) {
      result.textContent = e.message || 'Failed to fetch auth status.';
      result.className = 'alert-error';
    }
  }

  refreshWhatsAppAuth();
</script>
