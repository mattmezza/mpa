{# Agent Identity tab partial #}
<div class="space-y-6">
  {# Basic identity fields #}
  <div class="card" x-data="{
    agentName: {{ agent_name|default('', true)|tojson|forceescape }},
    idResult: '',
    idOk: false
  }">
    <h2 class="text-base mb-1">Identity</h2>
    <p class="text-muted text-xs mb-3">The agent's name — how it introduces itself.</p>

    <div class="space-y-3">
      <div>
        <label class="label">Agent name</label>
        <input type="text" class="input-sm" style="max-width:300px"
               x-model="agentName" placeholder="Clio">
      </div>
    </div>

    <div class="flex justify-end mt-3">
      <button class="btn-primary btn-sm"
              @click="
                fetch('/config', {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({values: {'agent.name': agentName}})
                })
                .then(r => { idOk = r.ok; return r.json(); })
                .then(d => {
                  idResult = idOk ? 'Identity saved' : (d.detail || 'Error');
                  if (idOk && window.showToast) { window.showToast('Identity saved'); }
                  if (idOk && window.updateAdminGreeting) { window.updateAdminGreeting('', agentName); }
                })
                .catch(e => { idOk = false; idResult = e.message; })
              ">
        Save identity
      </button>
    </div>
    <template x-if="idResult">
      <div :class="idOk ? 'alert-success' : 'alert-error'" class="mt-2" x-text="idResult"></div>
    </template>
  </div>

  {# Character #}
  <div class="card" x-data="{ charResult: '', charOk: false }">
    <h2 class="text-base mb-1">Character</h2>
    <p class="text-muted text-xs mb-3">Defines <em>how</em> the agent behaves — tone, decision-making style, language rules. Markdown format.</p>
    <textarea class="textarea" id="char-editor"
              style="min-height:300px; font-size:0.8rem; line-height:1.5; tab-size:2"
              @keydown.tab.prevent="
                const start = $el.selectionStart;
                const end = $el.selectionEnd;
                $el.value = $el.value.substring(0, start) + '  ' + $el.value.substring(end);
                $el.selectionStart = $el.selectionEnd = start + 2;
              ">{{ character }}</textarea>
    <div class="flex justify-end mt-3">
      <button class="btn-primary btn-sm"
              @click="
                fetch('/config/character', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({content: document.getElementById('char-editor').value})
                })
                .then(r => { charOk = r.ok; return r.json(); })
                .then(d => { charResult = charOk ? 'Character saved' : (d.detail || 'Error'); })
                .catch(e => { charOk = false; charResult = e.message; })
              ">
        Save character
      </button>
    </div>
    <template x-if="charResult">
      <div :class="charOk ? 'alert-success' : 'alert-error'" class="mt-2" x-text="charResult"></div>
    </template>
  </div>

  {# Personalia #}
  <div class="card" x-data="{ persResult: '', persOk: false }">
    <h2 class="text-base mb-1">Personalia</h2>
    <p class="text-muted text-xs mb-3">Defines <em>what</em> the agent is — identity, capabilities, limitations, history. Markdown format.</p>
    <textarea class="textarea" id="pers-editor"
              style="min-height:300px; font-size:0.8rem; line-height:1.5; tab-size:2"
              @keydown.tab.prevent="
                const start = $el.selectionStart;
                const end = $el.selectionEnd;
                $el.value = $el.value.substring(0, start) + '  ' + $el.value.substring(end);
                $el.selectionStart = $el.selectionEnd = start + 2;
              ">{{ personalia }}</textarea>
    <div class="flex justify-end mt-3">
      <button class="btn-primary btn-sm"
              @click="
                fetch('/config/personalia', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({content: document.getElementById('pers-editor').value})
                })
                .then(r => { persOk = r.ok; return r.json(); })
                .then(d => { persResult = persOk ? 'Personalia saved' : (d.detail || 'Error'); })
                .catch(e => { persOk = false; persResult = e.message; })
              ">
        Save personalia
      </button>
    </div>
    <template x-if="persResult">
      <div :class="persOk ? 'alert-success' : 'alert-error'" class="mt-2" x-text="persResult"></div>
    </template>
  </div>

  {# Voice #}
  <div class="card" x-data="{
    ttsEnabled: {{ tts_enabled|default('true', true)|tojson|forceescape }},
    sttModel: {{ stt_model|default('base', true)|tojson|forceescape }},
    ttsVoice: {{ tts_voice|default('en-US-AvaNeural', true)|tojson|forceescape }},
    voiceResult: '',
    voiceOk: false
  }">
    <h2 class="text-base mb-1">Voice</h2>
    <p class="text-muted text-xs mb-3">Configure speech-to-text (STT) and text-to-speech (TTS) used for voice messages.</p>

    <div class="space-y-3">
      <div class="flex items-center gap-2">
        <label class="label mb-0">Enable TTS replies</label>
        <input type="checkbox" x-model="ttsEnabled"
               :checked="ttsEnabled === 'true' || ttsEnabled === true">
      </div>

      <div>
        <label class="label">STT model</label>
        <select class="input-sm" style="max-width:240px" x-model="sttModel">
          <option value="base">Whisper Base</option>
          <option value="small">Whisper Small</option>
          <option value="medium">Whisper Medium</option>
          <option value="large">Whisper Large</option>
        </select>
        <p class="text-muted text-xs mt-1">Larger models are more accurate but slower.</p>
      </div>

      <div>
        <label class="label">TTS voice</label>
        <input type="text" class="input-sm" style="max-width:260px" x-model="ttsVoice" placeholder="en-US-AvaNeural">
        <p class="text-muted text-xs mt-1">Use Edge TTS voice names. Example: en-US-AvaNeural.</p>
      </div>
    </div>

    <div class="flex justify-end mt-3">
      <button class="btn-primary btn-sm"
              @click="
                const vals = {
                  'voice.tts_enabled': String(ttsEnabled === true || ttsEnabled === 'true'),
                  'voice.stt_model': sttModel,
                  'voice.tts_voice': ttsVoice
                };
                fetch('/config', {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({values: vals})
                })
                .then(r => { voiceOk = r.ok; return r.json(); })
                .then(d => {
                  voiceResult = voiceOk ? 'Voice settings saved' : (d.detail || 'Error');
                  if (voiceOk && window.showToast) { window.showToast('Voice settings saved'); }
                })
                .catch(e => { voiceOk = false; voiceResult = e.message; })
              ">
        Save voice
      </button>
    </div>
    <template x-if="voiceResult">
      <div :class="voiceOk ? 'alert-success' : 'alert-error'" class="mt-2" x-text="voiceResult"></div>
    </template>
  </div>
</div>
