{# Calendars tab partial #}
<div x-data='calendarTab({{ providers|tojson }}, {{ google_connected|tojson }}, {{ google_client_id|tojson }}, {{ has_oauth_creds|tojson }})'>
  {# ── Google Calendar OAuth 2.0 ──────────────────────────────────── #}
  <div class="card mb-4">
    <div class="flex items-center justify-between gap-2 mb-3">
      <div>
        <h4 class="text-sm">Google Calendar (OAuth 2.0)</h4>
        <p class="text-muted text-xs">Google requires OAuth 2.0 for CalDAV access. Connect your Google account to allow the agent to read and create calendar events.</p>
      </div>
      <template x-if="googleConnected">
        <span class="text-xs" style="color: var(--color-success, #22c55e);">Connected</span>
      </template>
    </div>

    <div class="grid gap-3 mb-3" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
      <div>
        <label class="label">OAuth Client ID</label>
        <input type="text" class="input-sm" x-model="oauthClientId" placeholder="123456789-abc.apps.googleusercontent.com">
        <p class="text-muted text-xs mt-1">From <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="text-decoration:underline">Google Cloud Console</a> &gt; Credentials &gt; OAuth 2.0 Client ID.</p>
      </div>
      <div>
        <label class="label">OAuth Client Secret</label>
        <input type="password" class="input-sm" x-model="oauthClientSecret" placeholder="GOCSPX-..." autocomplete="new-password">
        <p class="text-muted text-xs mt-1">The client secret paired with the Client ID above.</p>
      </div>
    </div>

    <div class="flex items-center gap-2 flex-wrap">
      <button class="btn btn-sm" type="button"
              @click="saveOAuthCreds()"
              :disabled="!oauthClientId.trim() || !oauthClientSecret.trim()">
        Save credentials
      </button>
      <button class="btn-primary btn-sm" type="button"
              @click="connectGoogle()"
              :disabled="!hasOAuthCreds">
        <span x-text="googleConnected ? 'Reconnect Google Calendar' : 'Connect Google Calendar'"></span>
      </button>
      <span class="text-xs text-muted" x-text="oauthStatus"></span>
    </div>
    <template x-if="oauthResult">
      <div :class="oauthOk ? 'alert-success' : 'alert-error'" class="mt-2" x-text="oauthResult"></div>
    </template>

    <div class="mt-3 text-xs text-muted">
      <strong>Setup steps</strong>
      <ol class="list-decimal ml-5 mt-1 space-y-1">
        <li>Go to <a href="https://console.cloud.google.com/apis/library/caldav-json.googleapis.com" target="_blank" style="text-decoration:underline">Google Cloud Console</a> and enable the <strong>CalDAV API</strong>.</li>
        <li>Create an OAuth 2.0 Client ID (type: <strong>Web application</strong>). Add <code x-text="window.location.origin + '/calendar/google/oauth/callback'"></code> as an authorized redirect URI.</li>
        <li>Paste the Client ID and Secret above, click <strong>Save credentials</strong>, then <strong>Connect Google Calendar</strong>.</li>
      </ol>
    </div>
  </div>

  {# ── CalDAV providers (non-Google or manual) ─────────────────────── #}
  <div class="flex items-center justify-between gap-2 mb-4 flex-wrap">
    <div>
      <h3 class="text-xs text-muted uppercase tracking-wider">Other CalDAV Providers</h3>
      <p class="text-muted text-xs">For iCloud, Fastmail, or other CalDAV servers that support app passwords.</p>
    </div>
    <button class="btn btn-sm" type="button" @click="addProvider()">Add provider</button>
  </div>

  <div class="grid gap-4">
    <template x-for="(provider, idx) in providers" :key="provider.id">
      <div class="card">
        <div class="flex items-center justify-between gap-2 mb-3">
          <div>
            <h4 class="text-sm">Provider <span x-text="idx + 1"></span></h4>
            <p class="text-muted text-xs">Give each provider a unique name, e.g. icloud, work.</p>
          </div>
          <button class="btn-danger btn-sm" type="button" @click="removeProvider(idx)">Remove</button>
        </div>

        <div class="grid gap-3" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
          <div>
            <label class="label">Name</label>
            <input type="text" class="input-sm" x-model="provider.name" placeholder="icloud">
            <p class="text-muted text-xs mt-1">Used in prompts and tooling to pick the calendar.</p>
          </div>
          <div>
            <label class="label">CalDAV URL</label>
            <input type="text" class="input-sm" x-model="provider.url" placeholder="https://.../caldav/.../events">
            <p class="text-muted text-xs mt-1">Find this in your provider's CalDAV settings.</p>
          </div>
          <div>
            <label class="label">Username / email</label>
            <input type="text" class="input-sm" x-model="provider.username" placeholder="you@example.com">
            <p class="text-muted text-xs mt-1">Often your email address.</p>
          </div>
          <div>
            <label class="label">App password</label>
            <input type="password" class="input-sm" x-model="provider.password" placeholder="xxxx xxxx xxxx xxxx" autocomplete="new-password">
            <p class="text-muted text-xs mt-1">Use an app password, not your main login password.</p>
          </div>
        </div>

        <div class="mt-3 text-xs text-muted">
          <strong>Where to get these values</strong>
          <ul class="list-disc ml-5 mt-1 space-y-1">
            <li>iCloud: Apple ID &gt; App-Specific Passwords, then use the CalDAV URL from iCloud Calendar settings.</li>
            <li>Fastmail/Outlook: find CalDAV URL in account settings, use an app password if available.</li>
          </ul>
        </div>
      </div>
    </template>
    <template x-if="providers.length === 0">
      <div class="text-muted text-xs">No additional CalDAV providers configured.</div>
    </template>
  </div>

  <div class="flex items-center gap-2 mt-4">
    <button class="btn-primary btn-sm" type="button" @click="saveProviders()">Save calendars</button>
    <span class="text-xs text-muted" x-text="status"></span>
  </div>
  <template x-if="result">
    <div :class="ok ? 'alert-success' : 'alert-error'" class="mt-2" x-text="result"></div>
  </template>
</div>
