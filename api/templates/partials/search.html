{# Search tab partial #}
<div class="space-y-6" x-data="{
  enabled: {{ enabled|default('false', true)|tojson }},
  provider: {{ provider|default('tavily', true)|tojson }},
  apiKey: {{ api_key|default('', true)|tojson }},
  maxResults: {{ max_results|default('5', true)|tojson }},
  result: '',
  resultOk: false,
  testing: false,
  testResult: ''
}">
  <div class="card">
    <h2 class="text-base mb-1">Web Search</h2>
    <p class="text-muted text-xs mb-4">Configure web search capabilities for the agent. Currently supports Tavily.</p>

    <div class="space-y-3">
      <div class="flex items-center gap-2">
        <label class="label mb-0">Enabled</label>
        <input type="checkbox" x-model="enabled"
               :checked="enabled === 'true' || enabled === true">
      </div>

      <div>
        <label class="label">Provider</label>
        <select class="input-sm" style="max-width:300px" x-model="provider">
          <option value="tavily">Tavily</option>
        </select>
      </div>

      <div>
        <label class="label">API Key</label>
        <input type="password" class="input-sm" style="max-width:500px"
               x-model="apiKey" placeholder="tvly-...">
      </div>

      <div>
        <label class="label">Max results</label>
        <input type="number" class="input-sm" style="max-width:120px"
               x-model="maxResults" min="1" max="20">
        <p class="text-muted text-xs mt-1">Number of search results returned per query.</p>
      </div>
    </div>

    <div class="flex items-center gap-2 mt-4">
      <button class="btn-primary btn-sm"
              @click="
                const vals = {
                  'search.enabled': String(enabled === true || enabled === 'true'),
                  'search.provider': provider,
                  'search.api_key': apiKey,
                  'search.max_results': String(maxResults)
                };
                fetch('/config', {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({values: vals})
                })
                .then(r => { resultOk = r.ok; return r.json(); })
                .then(d => { result = resultOk ? 'Search settings saved' : (d.detail || 'Error'); })
                .catch(e => { resultOk = false; result = e.message; })
              ">
        Save
      </button>
      <button class="btn btn-sm" :disabled="testing || !apiKey"
              @click="
                testing = true; testResult = '';
                fetch('/setup/test-connection', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({service: 'tavily', api_key: apiKey})
                })
                .then(r => r.json())
                .then(d => { testing = false; testResult = d.ok ? 'Connection OK' : ('Failed: ' + (d.error || 'unknown')); })
                .catch(e => { testing = false; testResult = 'Error: ' + e.message; })
              ">
        <span x-show="!testing">Test connection</span>
        <span x-show="testing">Testing...</span>
      </button>
    </div>

    <template x-if="result">
      <div :class="resultOk ? 'alert-success' : 'alert-error'" class="mt-2" x-text="result"></div>
    </template>
    <template x-if="testResult">
      <div :class="testResult.startsWith('Connection') ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResult"></div>
    </template>
  </div>
</div>
