{# LLM tab partial #}
<div class="space-y-6" x-data="llmTab({{ api_key|default('', true)|tojson|forceescape }}, {{ model|default('', true)|tojson|forceescape }})">
  <div class="card">
    <h2 class="text-base mb-1">Language Model</h2>
    <p class="text-muted text-xs mb-4">Configure the Anthropic API key and model used by the agent.</p>

    <form class="space-y-3" @submit.prevent>
      <div>
        <label class="label">API Key</label>
        <input type="text" class="input-sm" style="max-width:500px; display:none"
               autocomplete="username" aria-hidden="true" tabindex="-1">
        <input type="password" class="input-sm" style="max-width:500px"
               autocomplete="new-password"
               x-model="apiKey" placeholder="sk-ant-...">
        <p class="text-muted text-xs mt-1">Your Anthropic API key. Stored encrypted in the config database.</p>
      </div>

      <div>
        <label class="label">Model</label>
        <select class="input-sm" style="max-width:500px" x-model="model">
          <option value="claude-opus-4-6">Claude Opus 4.6</option>
          <option value="claude-opus-4-5">Claude Opus 4.5</option>
          <option value="claude-sonnet-4-6">Claude Sonnet 4.6</option>
          <option value="claude-sonnet-4-5-20250514">Claude Sonnet 4.5</option>
          <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
          <option value="claude-haiku-4-5">Claude Haiku 4.5</option>
        </select>
        <p class="text-muted text-xs mt-1">The model to use for agent conversations. Haiku is faster and cheaper; Sonnet is more capable.</p>
      </div>
    </form>

    <div class="flex items-center gap-2 mt-4">
      <button class="btn-primary btn-sm"
              @click="
                fetch('/config', {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({values: {'agent.anthropic_api_key': apiKey, 'agent.model': model}})
                })
                .then(r => { resultOk = r.ok; return r.json(); })
                .then(d => {
                  result = resultOk ? 'LLM settings saved' : (d.detail || 'Error');
                  if (resultOk && window.showToast) { window.showToast('LLM settings saved'); }
                })
                .catch(e => { resultOk = false; result = e.message; })
              ">
        Save
      </button>
      <button class="btn btn-sm" :disabled="testing || !apiKey"
              @click="
                testing = true; testResult = '';
                fetch('/setup/test-connection', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({service: 'anthropic', api_key: apiKey})
                })
                .then(r => r.json())
                .then(d => { testResult = d.ok ? 'Connection OK' : ('Failed: ' + (d.error || 'unknown')); })
                .catch(e => { testResult = 'Error: ' + e.message; })
                .finally(() => { testing = false; })
              ">
        <span x-show="!testing">Test connection</span>
        <span x-show="testing">Testing...</span>
      </button>
    </div>

    <template x-if="result">
      <div :class="resultOk ? 'alert-success' : 'alert-error'" class="mt-2" x-text="result"></div>
    </template>
    <template x-if="testResult">
      <div :class="testResult.startsWith('Connection') ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResult"></div>
    </template>
  </div>
</div>
