{# LLM tab partial #}
<div class="space-y-6" x-data="llmTab(
  {{ provider|default('anthropic', true)|tojson|forceescape }},
  {{ anthropic_api_key|default('', true)|tojson|forceescape }},
  {{ model|default('', true)|tojson|forceescape }},
  {{ openai_api_key|default('', true)|tojson|forceescape }},
  {{ openai_base_url|default('', true)|tojson|forceescape }},
  {{ grok_api_key|default('', true)|tojson|forceescape }},
  {{ grok_base_url|default('', true)|tojson|forceescape }},
  {{ deepseek_api_key|default('', true)|tojson|forceescape }},
  {{ deepseek_base_url|default('', true)|tojson|forceescape }}
)">
  <div class="card">
    <h2 class="text-base mb-1">Language Model</h2>
    <p class="text-muted text-xs mb-4">Choose the provider and model used by the agent.</p>

    <form class="space-y-3" @submit.prevent>
      <div>
        <label class="label">Provider</label>
        <select class="input-sm" style="max-width:500px" x-model="provider">
          <option value="anthropic">Anthropic</option>
          <option value="openai">OpenAI</option>
          <option value="grok">Grok (xAI)</option>
          <option value="deepseek">DeepSeek</option>
        </select>
      </div>

      <div x-show="provider === 'anthropic'">
        <label class="label">Anthropic API Key</label>
        <input type="text" class="input-sm" style="max-width:500px; display:none"
               autocomplete="username" aria-hidden="true" tabindex="-1">
        <input type="password" class="input-sm" style="max-width:500px"
               autocomplete="new-password"
               x-model="apiKey" placeholder="sk-ant-...">
        <p class="text-muted text-xs mt-1">Used for Claude models.</p>
      </div>

      <div x-show="provider === 'openai'">
        <label class="label">OpenAI API Key</label>
        <input type="password" class="input-sm" style="max-width:500px"
               autocomplete="new-password"
               x-model="openaiKey" placeholder="sk-...">
        <p class="text-muted text-xs mt-1">Used for GPT models.</p>
      </div>

      <div x-show="provider === 'grok'">
        <label class="label">Grok API Key</label>
        <input type="password" class="input-sm" style="max-width:500px"
               autocomplete="new-password"
               x-model="grokKey" placeholder="xai-...">
        <p class="text-muted text-xs mt-1">Used for xAI Grok models.</p>
      </div>

      <div x-show="provider === 'deepseek'">
        <label class="label">DeepSeek API Key</label>
        <input type="password" class="input-sm" style="max-width:500px"
               autocomplete="new-password"
               x-model="deepseekKey" placeholder="sk-...">
        <p class="text-muted text-xs mt-1">Used for DeepSeek models.</p>
      </div>

      <div x-show="provider !== 'anthropic'">
        <label class="label">Base URL (optional)</label>
        <input type="text" class="input-sm" style="max-width:500px"
               x-model="provider === 'openai' ? openaiBaseUrl : (provider === 'grok' ? grokBaseUrl : deepseekBaseUrl)"
               placeholder="https://...">
        <p class="text-muted text-xs mt-1">Override the default API endpoint.</p>
      </div>

      <div>
        <label class="label">Model</label>
        <select class="input-sm" style="max-width:500px" x-model="model">
          <optgroup label="Anthropic">
            <option value="claude-opus-4-6">Claude Opus 4.6</option>
            <option value="claude-opus-4-5">Claude Opus 4.5</option>
            <option value="claude-sonnet-4-6">Claude Sonnet 4.6</option>
            <option value="claude-sonnet-4-5-20250514">Claude Sonnet 4.5</option>
            <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
            <option value="claude-haiku-4-5">Claude Haiku 4.5</option>
          </optgroup>
          <optgroup label="OpenAI">
            <option value="gpt-4o-mini">GPT-4o mini</option>
            <option value="gpt-4o">GPT-4o</option>
            <option value="gpt-4.1-mini">GPT-4.1 mini</option>
            <option value="gpt-4.1">GPT-4.1</option>
          </optgroup>
          <optgroup label="Grok">
            <option value="grok-2-latest">Grok-2 Latest</option>
            <option value="grok-2-mini">Grok-2 Mini</option>
          </optgroup>
          <optgroup label="DeepSeek">
            <option value="deepseek-chat">DeepSeek Chat</option>
            <option value="deepseek-reasoner">DeepSeek Reasoner</option>
          </optgroup>
        </select>
        <p class="text-muted text-xs mt-1">Pick a model that matches your provider.</p>
      </div>
    </form>

    <div class="flex items-center gap-2 mt-4">
      <button class="btn-primary btn-sm"
              @click="
                fetch('/config', {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  const resolvedBaseUrl = currentBaseUrl() || (provider === 'grok' ? 'https://api.x.ai/v1' : (provider === 'deepseek' ? 'https://api.deepseek.com' : ''));
                  body: JSON.stringify({values: {
                    'agent.llm_provider': provider,
                    'agent.anthropic_api_key': apiKey,
                    'agent.openai_api_key': openaiKey,
                    'agent.openai_base_url': provider === 'openai' ? resolvedBaseUrl : openaiBaseUrl,
                    'agent.grok_api_key': grokKey,
                    'agent.grok_base_url': provider === 'grok' ? resolvedBaseUrl : grokBaseUrl,
                    'agent.deepseek_api_key': deepseekKey,
                    'agent.deepseek_base_url': provider === 'deepseek' ? resolvedBaseUrl : deepseekBaseUrl,
                    'agent.model': model
                  }})
                })
                .then(r => { resultOk = r.ok; return r.json(); })
                .then(d => {
                  result = resultOk ? 'LLM settings saved' : (d.detail || 'Error');
                  if (resultOk && window.showToast) { window.showToast('LLM settings saved'); }
                })
                .catch(e => { resultOk = false; result = e.message; })
              ">
        Save
      </button>
      <button class="btn btn-sm" :disabled="testing || !currentKey()"
              @click="
                testing = true; testResult = '';
                fetch('/setup/test-connection', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({service: provider, api_key: currentKey(), base_url: currentBaseUrl() || (provider === 'grok' ? 'https://api.x.ai/v1' : (provider === 'deepseek' ? 'https://api.deepseek.com' : ''))})
                })
                .then(r => r.json())
                .then(d => { testResult = d.ok ? 'Connection OK' : ('Failed: ' + (d.error || 'unknown')); })
                .catch(e => { testResult = 'Error: ' + e.message; })
                .finally(() => { testing = false; })
              ">
        <span x-show="!testing">Test connection</span>
        <span x-show="testing">Testing...</span>
      </button>
    </div>

    <template x-if="result">
      <div :class="resultOk ? 'alert-success' : 'alert-error'" class="mt-2" x-text="result"></div>
    </template>
    <template x-if="testResult">
      <div :class="testResult.startsWith('Connection') ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResult"></div>
    </template>
  </div>
</div>
