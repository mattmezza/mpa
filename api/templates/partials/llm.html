{# LLM tab partial #}
<div class="space-y-6" x-data="llmTab(
  {{ provider|default('anthropic', true)|tojson|forceescape }},
  {{ anthropic_api_key|default('', true)|tojson|forceescape }},
  {{ model|default('', true)|tojson|forceescape }},
  {{ openai_api_key|default('', true)|tojson|forceescape }},
  {{ openai_base_url|default('', true)|tojson|forceescape }},
  {{ google_api_key|default('', true)|tojson|forceescape }},
  {{ google_base_url|default('', true)|tojson|forceescape }},
  {{ grok_api_key|default('', true)|tojson|forceescape }},
  {{ grok_base_url|default('', true)|tojson|forceescape }},
  {{ deepseek_api_key|default('', true)|tojson|forceescape }},
  {{ deepseek_base_url|default('', true)|tojson|forceescape }}
)">
  <div class="card">
    <h2 class="text-base mb-1">Active Inference Provider</h2>
    <p class="text-muted text-xs mb-4">Select the provider used for agent inference after testing its connection.</p>

    <form class="space-y-3" @submit.prevent>
      <div>
        <label class="label">Provider</label>
        <select class="input-sm" style="max-width:500px" x-model="provider">
          <option value="anthropic">Anthropic</option>
          <option value="openai">OpenAI</option>
          <option value="google">Google Gemini</option>
          <option value="grok">Grok (xAI)</option>
          <option value="deepseek">DeepSeek</option>
        </select>
      </div>

      <div>
        <label class="label">Model</label>
        <select class="input-sm" style="max-width:500px" x-model="model">
          <template x-for="item in (models[provider] || [])" :key="item.value">
            <option :value="item.value" x-text="item.label"></option>
          </template>
        </select>
        <p class="text-muted text-xs mt-1">Pick a model that matches your provider.</p>
      </div>
    </form>

    <div class="flex items-center gap-2 mt-4">
      <button class="btn-primary btn-sm"
              @click="
                fetch('/config', {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({values: {
                    'agent.llm_provider': provider,
                    'agent.anthropic_api_key': apiKey,
                    'agent.openai_api_key': openaiKey,
                    'agent.openai_base_url': openaiBaseUrl,
                    'agent.google_api_key': googleKey,
                    'agent.google_base_url': googleBaseUrl,
                    'agent.grok_api_key': grokKey,
                    'agent.grok_base_url': grokBaseUrl,
                    'agent.deepseek_api_key': deepseekKey,
                    'agent.deepseek_base_url': deepseekBaseUrl,
                    'agent.model': model
                  }})
                })
                .then(r => { resultOk = r.ok; return r.json(); })
                .then(d => {
                  result = resultOk ? 'LLM settings saved' : (d.detail || 'Error');
                  if (resultOk && window.showToast) { window.showToast('LLM settings saved'); }
                })
                .catch(e => { resultOk = false; result = e.message; })
              ">
        Save
      </button>
    </div>

    <template x-if="result">
      <div :class="resultOk ? 'alert-success' : 'alert-error'" class="mt-2" x-text="result"></div>
    </template>
  </div>

  <div class="card">
    <h2 class="text-base mb-1">Anthropic</h2>
    <p class="text-muted text-xs mb-4">Configure the Anthropic API key and test the connection.</p>
    <form class="space-y-3" @submit.prevent>
      <div>
        <label class="label">Anthropic API Key</label>
        <input type="text" class="input-sm" style="max-width:500px; display:none"
               autocomplete="username" aria-hidden="true" tabindex="-1">
        <input type="password" class="input-sm" style="max-width:500px"
               autocomplete="new-password"
               x-model="apiKey" placeholder="sk-ant-...">
        <p class="text-muted text-xs mt-1">Get a key at <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a></p>
        <div class="flex items-center gap-2 mt-2">
          <button class="btn btn-sm" type="button" :disabled="testing.anthropic || !apiKey"
                  @click="testProvider('anthropic')">
            <span x-show="!testing.anthropic">Test connection</span>
            <span x-show="testing.anthropic">Testing...</span>
          </button>
        </div>
        <template x-if="testResults.anthropic">
          <div :class="tests.anthropic ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResults.anthropic"></div>
        </template>
      </div>
    </form>
    <div class="flex items-center gap-2 mt-4">
      <button class="btn btn-sm"
              @click="
                fetch('/config', {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({values: {
                    'agent.anthropic_api_key': apiKey
                  }})
                })
                .then(r => { resultOk = r.ok; return r.json(); })
                .then(d => {
                  result = resultOk ? 'Anthropic settings saved' : (d.detail || 'Error');
                  if (resultOk && window.showToast) { window.showToast('Anthropic settings saved'); }
                })
                .catch(e => { resultOk = false; result = e.message; })
              ">
        Save Anthropic
      </button>
    </div>
  </div>

  <div class="card">
    <h2 class="text-base mb-1">OpenAI</h2>
    <p class="text-muted text-xs mb-4">Configure the OpenAI key and optional base URL, then test the connection.</p>
    <form class="space-y-3" @submit.prevent>
      <div>
        <label class="label">OpenAI API Key</label>
        <input type="password" class="input-sm" style="max-width:500px"
               autocomplete="new-password"
               x-model="openaiKey" placeholder="sk-...">
        <p class="text-muted text-xs mt-1">Create one in <a href="https://platform.openai.com/account/api-keys" target="_blank">platform.openai.com</a></p>
      </div>
      <div>
        <label class="label">OpenAI Base URL (optional)</label>
        <input type="text" class="input-sm" style="max-width:500px"
               x-model="openaiBaseUrl" placeholder="https://...">
        <div class="flex items-center gap-2 mt-2">
          <button class="btn btn-sm" type="button" :disabled="testing.openai || !openaiKey"
                  @click="testProvider('openai')">
            <span x-show="!testing.openai">Test connection</span>
            <span x-show="testing.openai">Testing...</span>
          </button>
        </div>
        <template x-if="testResults.openai">
          <div :class="tests.openai ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResults.openai"></div>
        </template>
      </div>
    </form>
    <div class="flex items-center gap-2 mt-4">
      <button class="btn btn-sm"
              @click="
                fetch('/config', {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({values: {
                    'agent.openai_api_key': openaiKey,
                    'agent.openai_base_url': openaiBaseUrl
                  }})
                })
                .then(r => { resultOk = r.ok; return r.json(); })
                .then(d => {
                  result = resultOk ? 'OpenAI settings saved' : (d.detail || 'Error');
                  if (resultOk && window.showToast) { window.showToast('OpenAI settings saved'); }
                })
                .catch(e => { resultOk = false; result = e.message; })
              ">
        Save OpenAI
      </button>
    </div>
  </div>

  <div class="card">
    <h2 class="text-base mb-1">Google Gemini</h2>
    <p class="text-muted text-xs mb-4">Configure the Google API key and optional base URL, then test the connection.</p>
    <form class="space-y-3" @submit.prevent>
      <div>
        <label class="label">Google API Key</label>
        <input type="password" class="input-sm" style="max-width:500px"
               autocomplete="new-password"
               x-model="googleKey" placeholder="AIza...">
        <p class="text-muted text-xs mt-1">Create a key in <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></p>
      </div>
      <div>
        <label class="label">Google Base URL (optional)</label>
        <input type="text" class="input-sm" style="max-width:500px"
               x-model="googleBaseUrl" placeholder="https://generativelanguage.googleapis.com/v1beta/openai">
        <div class="flex items-center gap-2 mt-2">
          <button class="btn btn-sm" type="button" :disabled="testing.google || !googleKey"
                  @click="testProvider('google')">
            <span x-show="!testing.google">Test connection</span>
            <span x-show="testing.google">Testing...</span>
          </button>
        </div>
        <template x-if="testResults.google">
          <div :class="tests.google ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResults.google"></div>
        </template>
      </div>
    </form>
    <div class="flex items-center gap-2 mt-4">
      <button class="btn btn-sm"
              @click="
                fetch('/config', {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({values: {
                    'agent.google_api_key': googleKey,
                    'agent.google_base_url': googleBaseUrl
                  }})
                })
                .then(r => { resultOk = r.ok; return r.json(); })
                .then(d => {
                  result = resultOk ? 'Google settings saved' : (d.detail || 'Error');
                  if (resultOk && window.showToast) { window.showToast('Google settings saved'); }
                })
                .catch(e => { resultOk = false; result = e.message; })
              ">
        Save Google
      </button>
    </div>
  </div>

  <div class="card">
    <h2 class="text-base mb-1">Grok (xAI)</h2>
    <p class="text-muted text-xs mb-4">Configure the Grok key and optional base URL, then test the connection.</p>
    <form class="space-y-3" @submit.prevent>
      <div>
        <label class="label">Grok API Key</label>
        <input type="password" class="input-sm" style="max-width:500px"
               autocomplete="new-password"
               x-model="grokKey" placeholder="xai-...">
        <p class="text-muted text-xs mt-1">Create a key in <a href="https://console.x.ai/" target="_blank">console.x.ai</a></p>
      </div>
      <div>
        <label class="label">Grok Base URL (optional)</label>
        <input type="text" class="input-sm" style="max-width:500px"
               x-model="grokBaseUrl" placeholder="https://api.x.ai/v1">
        <div class="flex items-center gap-2 mt-2">
          <button class="btn btn-sm" type="button" :disabled="testing.grok || !grokKey"
                  @click="testProvider('grok')">
            <span x-show="!testing.grok">Test connection</span>
            <span x-show="testing.grok">Testing...</span>
          </button>
        </div>
        <template x-if="testResults.grok">
          <div :class="tests.grok ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResults.grok"></div>
        </template>
      </div>
    </form>
    <div class="flex items-center gap-2 mt-4">
      <button class="btn btn-sm"
              @click="
                fetch('/config', {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({values: {
                    'agent.grok_api_key': grokKey,
                    'agent.grok_base_url': grokBaseUrl
                  }})
                })
                .then(r => { resultOk = r.ok; return r.json(); })
                .then(d => {
                  result = resultOk ? 'Grok settings saved' : (d.detail || 'Error');
                  if (resultOk && window.showToast) { window.showToast('Grok settings saved'); }
                })
                .catch(e => { resultOk = false; result = e.message; })
              ">
        Save Grok
      </button>
    </div>
  </div>

  <div class="card">
    <h2 class="text-base mb-1">DeepSeek</h2>
    <p class="text-muted text-xs mb-4">Configure the DeepSeek key and optional base URL, then test the connection.</p>
    <form class="space-y-3" @submit.prevent>
      <div>
        <label class="label">DeepSeek API Key</label>
        <input type="password" class="input-sm" style="max-width:500px"
               autocomplete="new-password"
               x-model="deepseekKey" placeholder="sk-...">
        <p class="text-muted text-xs mt-1">Create a key in <a href="https://platform.deepseek.com/api_keys" target="_blank">platform.deepseek.com</a></p>
      </div>
      <div>
        <label class="label">DeepSeek Base URL (optional)</label>
        <input type="text" class="input-sm" style="max-width:500px"
               x-model="deepseekBaseUrl" placeholder="https://api.deepseek.com">
        <div class="flex items-center gap-2 mt-2">
          <button class="btn btn-sm" type="button" :disabled="testing.deepseek || !deepseekKey"
                  @click="testProvider('deepseek')">
            <span x-show="!testing.deepseek">Test connection</span>
            <span x-show="testing.deepseek">Testing...</span>
          </button>
        </div>
        <template x-if="testResults.deepseek">
          <div :class="tests.deepseek ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResults.deepseek"></div>
        </template>
      </div>
    </form>
    <div class="flex items-center gap-2 mt-4">
      <button class="btn btn-sm"
              @click="
                fetch('/config', {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({values: {
                    'agent.deepseek_api_key': deepseekKey,
                    'agent.deepseek_base_url': deepseekBaseUrl
                  }})
                })
                .then(r => { resultOk = r.ok; return r.json(); })
                .then(d => {
                  result = resultOk ? 'DeepSeek settings saved' : (d.detail || 'Error');
                  if (resultOk && window.showToast) { window.showToast('DeepSeek settings saved'); }
                })
                .catch(e => { resultOk = false; result = e.message; })
              ">
        Save DeepSeek
      </button>
    </div>
  </div>
</div>
