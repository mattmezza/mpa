{# Memory tab partial #}
  <div x-data="{
    dbPath: {{ memory_db_path|default('data/memory.db', true)|tojson|forceescape }},
    longTermLimit: {{ memory_long_term_limit|default('50', true)|tojson|forceescape }},
    extractionModel: {{ memory_extraction_model|default('claude-haiku-4-5', true)|tojson|forceescape }},
    consolidationModel: {{ memory_consolidation_model|default('claude-haiku-4-5', true)|tojson|forceescape }},
    cfgResult: '',
    cfgOk: false
  }">
  {# Memory config section #}
  <div class="card mb-6">
    <h2 class="text-base mb-1">Memory Settings</h2>
    <p class="text-muted text-xs mb-3">Configure memory storage and the models used for extraction and consolidation.</p>

    <div class="space-y-3">
      <div>
        <label class="label">Database path</label>
        <input type="text" class="input-sm" style="max-width:400px"
               x-model="dbPath" placeholder="data/memory.db">
      </div>
      <div>
        <label class="label">Long-term limit</label>
        <input type="number" class="input-sm" style="max-width:120px"
               x-model="longTermLimit" min="1" max="500">
        <p class="text-muted text-xs mt-1">Maximum number of long-term memories before consolidation triggers cleanup.</p>
      </div>
      <div>
        <label class="label">Extraction model</label>
        <select class="input-sm" style="max-width:400px" x-model="extractionModel">
          <option value="claude-opus-4-6">Claude Opus 4.6</option>
          <option value="claude-opus-4-5">Claude Opus 4.5</option>
          <option value="claude-sonnet-4-6">Claude Sonnet 4.6</option>
          <option value="claude-haiku-4-5">Claude Haiku 4.5</option>
          <option value="claude-sonnet-4-5-20250514">Claude Sonnet 4.5</option>
          <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
        </select>
        <p class="text-muted text-xs mt-1">Model used to extract memories from conversations.</p>
      </div>
      <div>
        <label class="label">Consolidation model</label>
        <select class="input-sm" style="max-width:400px" x-model="consolidationModel">
          <option value="claude-opus-4-6">Claude Opus 4.6</option>
          <option value="claude-opus-4-5">Claude Opus 4.5</option>
          <option value="claude-sonnet-4-6">Claude Sonnet 4.6</option>
          <option value="claude-haiku-4-5">Claude Haiku 4.5</option>
          <option value="claude-sonnet-4-5-20250514">Claude Sonnet 4.5</option>
          <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
        </select>
        <p class="text-muted text-xs mt-1">Model used to consolidate and merge duplicate memories.</p>
      </div>
    </div>

    <div class="flex justify-end mt-3">
      <button class="btn-primary btn-sm"
              @click="
                const vals = {
                  'memory.db_path': dbPath,
                  'memory.long_term_limit': String(longTermLimit),
                  'memory.extraction_model': extractionModel,
                  'memory.consolidation_model': consolidationModel
                };
                fetch('/config', {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                  },
                  body: JSON.stringify({values: vals})
                })
                .then(r => { cfgOk = r.ok; return r.json(); })
                .then(d => {
                  cfgResult = cfgOk ? 'Memory settings saved' : (d.detail || 'Error');
                  if (cfgOk && window.showToast) { window.showToast('Memory settings saved'); }
                })
                .catch(e => { cfgOk = false; cfgResult = e.message; })
              ">
        Save settings
      </button>
    </div>
    <template x-if="cfgResult">
      <div :class="cfgOk ? 'alert-success' : 'alert-error'" class="mt-2" x-text="cfgResult"></div>
    </template>
  </div>

  {# Memory data #}
  <div class="flex items-center gap-2 mb-4">
    <button class="btn btn-sm" hx-get="/partials/memory" hx-target="#tab-content" hx-swap="innerHTML">
      Refresh
    </button>
    <button class="btn btn-sm" hx-post="/memory/consolidate" hx-target="#consolidation-result" hx-swap="innerHTML">
      Run consolidation
    </button>
    <span id="consolidation-result" class="text-xs"></span>
  </div>

  {# Long-term memories #}
  <h3 class="text-xs text-muted uppercase tracking-wider mb-2">Long-term</h3>
  <div class="overflow-x-auto mb-6">
    <table class="table">
      <thead>
        <tr>
          <th class="w-10">ID</th>
          <th class="w-20">Category</th>
          <th class="w-24">Subject</th>
          <th>Content</th>
          <th class="w-10"></th>
        </tr>
      </thead>
      <tbody>
        {% for m in long_term %}
        <tr>
          <td class="text-xs">{{ m.id }}</td>
          <td class="text-xs">{{ m.category }}</td>
          <td class="text-xs">{{ m.subject }}</td>
          <td class="text-xs break-all">{{ m.content }}</td>
          <td>
            <button class="btn-danger btn-sm"
                    hx-post="/memory/delete" hx-target="#tab-content" hx-swap="innerHTML"
                    hx-vals='{"tier": "long-term", "memory_id": "{{ m.id }}"}'
                    hx-confirm="Delete this memory?">
              x
            </button>
          </td>
        </tr>
        {% endfor %}
        {% if not long_term %}
        <tr><td colspan="5" class="text-muted text-xs text-center py-4">No long-term memories</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  {# Short-term memories #}
  <h3 class="text-xs text-muted uppercase tracking-wider mb-2">Short-term (active)</h3>
  <div class="overflow-x-auto">
    <table class="table">
      <thead>
        <tr>
          <th class="w-10">ID</th>
          <th>Content</th>
          <th class="w-32">Expires</th>
          <th class="w-10"></th>
        </tr>
      </thead>
      <tbody>
        {% for m in short_term %}
        <tr>
          <td class="text-xs">{{ m.id }}</td>
          <td class="text-xs break-all">{{ m.content }}</td>
          <td class="text-xs">{{ m.expires_at }}</td>
          <td>
            <button class="btn-danger btn-sm"
                    hx-post="/memory/delete" hx-target="#tab-content" hx-swap="innerHTML"
                    hx-vals='{"tier": "short-term", "memory_id": "{{ m.id }}"}'
                    hx-confirm="Delete this memory?">
              x
            </button>
          </td>
        </tr>
        {% endfor %}
        {% if not short_term %}
        <tr><td colspan="4" class="text-muted text-xs text-center py-4">No active short-term memories</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
