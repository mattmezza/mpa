<div class="card" x-data="{
  provider: {{ step_ctx.provider|default('anthropic')|tojson|forceescape }},
  model: {{ step_ctx.model|default('', true)|tojson|forceescape }},
  tests: { anthropic: false, openai: false, google: false, grok: false, deepseek: false },
  testResults: { anthropic: '', openai: '', google: '', grok: '', deepseek: '' },
  testing: false,
  models: {
    anthropic: [
      {value: 'claude-4-6-opus', label: 'claude-4-6-opus'},
      {value: 'claude-4-6-sonnet', label: 'claude-4-6-sonnet'},
      {value: 'claude-4-5-haiku', label: 'claude-4-5-haiku'}
    ],
    openai: [
      {value: 'gpt-5.2-thinking', label: 'gpt-5.2-thinking'},
      {value: 'gpt-5.2-pro', label: 'gpt-5.2-pro'},
      {value: 'gpt-5.2-instant', label: 'gpt-5.2-instant'},
      {value: 'gpt-5-mini', label: 'gpt-5-mini'}
    ],
    google: [
      {value: 'gemini-deep-think-latest', label: 'gemini-deep-think-latest'},
      {value: 'gemini-pro-latest', label: 'gemini-pro-latest'},
      {value: 'gemini-flash-latest', label: 'gemini-flash-latest'}
    ],
    grok: [
      {value: 'grok-4.20-beta', label: 'grok-4.20-beta'},
      {value: 'grok-4-latest', label: 'grok-4-latest'},
      {value: 'grok-4.1-fast', label: 'grok-4.1-fast'}
    ],
    deepseek: [
      {value: 'deepseek-chat', label: 'deepseek-chat'},
      {value: 'deepseek-reasoner', label: 'deepseek-reasoner'}
    ]
  },
  init() {
    const savedModel = this.model;
    this.$nextTick(() => { this.model = savedModel; });
  },
  resetModel() {
    const list = this.models[this.provider] || [];
    if (list.length) { this.model = list[0].value; }
  }
}">
  <h2 class="text-base mb-3">LLM Provider</h2>

  <div class="card" style="padding: 0; box-shadow: none; border: 0;">
    <h3 class="text-sm mb-2">Active Inference Provider</h3>
    <p class="text-muted text-xs mb-3">Select the provider used for inference after testing it.</p>

    <label class="label" for="w-provider">Provider</label>
    <select class="select" id="w-provider" name="provider" x-model="provider" @change="resetModel()">
      <option value="anthropic" {{ 'selected' if step_ctx.provider|default('anthropic') == 'anthropic' }}>Anthropic</option>
      <option value="openai" {{ 'selected' if step_ctx.provider|default('') == 'openai' }}>OpenAI</option>
      <option value="google" {{ 'selected' if step_ctx.provider|default('') == 'google' }}>Google Gemini</option>
      <option value="grok" {{ 'selected' if step_ctx.provider|default('') == 'grok' }}>Grok (xAI)</option>
      <option value="deepseek" {{ 'selected' if step_ctx.provider|default('') == 'deepseek' }}>DeepSeek</option>
    </select>

  <label class="label mt-3" for="w-model">Model</label>
  <select class="select" id="w-model" name="model" x-model="model">
    <template x-for="item in (models[provider] || [])" :key="item.value">
      <option :value="item.value" x-text="item.label"></option>
    </template>
  </select>

  </div>

  <div class="card" style="padding: 0; box-shadow: none; border: 0; margin-top: 16px;">
    <h3 class="text-sm mb-2">Anthropic</h3>
    <label class="label" for="w-anthropic-key">Anthropic API Key</label>
    <input type="password" class="input" id="w-anthropic-key" placeholder="sk-ant-..."
           value="{{ step_ctx.anthropic_api_key|default('') }}">
    <p class="hint">Get one at <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a></p>

    <div class="mt-3">
      <button class="btn" :disabled="testing"
              @click="
                testing = true;
                const provider = 'anthropic';
                const apiKey = document.getElementById('w-anthropic-key').value;
                fetch('/setup/test-connection', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({service: provider, api_key: apiKey})
                })
                .then(r => r.json())
                .then(d => {
                  tests[provider] = !!d.ok;
                  testResults[provider] = d.ok ? 'Connection successful' + (d.response ? ': ' + d.response : '') : d.error;
                })
                .catch(e => {
                  tests[provider] = false;
                  testResults[provider] = e.message;
                })
                .finally(() => { testing = false; })
              ">
        <span x-show="testing" class="spinner mr-1"></span>
        Test connection
      </button>
    </div>
    <template x-if="testResults.anthropic">
      <div :class="tests.anthropic ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResults.anthropic"></div>
    </template>
  </div>

  <div class="card" style="padding: 0; box-shadow: none; border: 0; margin-top: 16px;">
    <h3 class="text-sm mb-2">OpenAI</h3>
    <label class="label" for="w-openai-key">OpenAI API Key</label>
    <input type="password" class="input" id="w-openai-key" placeholder="sk-..."
           value="{{ step_ctx.openai_api_key|default('') }}">
    <p class="hint">Create one in <a href="https://platform.openai.com/account/api-keys" target="_blank">platform.openai.com</a></p>
    <label class="label mt-2" for="w-openai-base-url">OpenAI Base URL (optional)</label>
    <input type="text" class="input" id="w-openai-base-url" placeholder="https://..."
           value="{{ step_ctx.openai_base_url|default('') }}">

    <div class="mt-3">
      <button class="btn" :disabled="testing"
              @click="
                testing = true;
                const provider = 'openai';
                const apiKey = document.getElementById('w-openai-key').value;
                const baseUrl = document.getElementById('w-openai-base-url').value;
                fetch('/setup/test-connection', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({service: provider, api_key: apiKey, base_url: baseUrl})
                })
                .then(r => r.json())
                .then(d => {
                  tests[provider] = !!d.ok;
                  testResults[provider] = d.ok ? 'Connection successful' + (d.response ? ': ' + d.response : '') : d.error;
                })
                .catch(e => {
                  tests[provider] = false;
                  testResults[provider] = e.message;
                })
                .finally(() => { testing = false; })
              ">
        <span x-show="testing" class="spinner mr-1"></span>
        Test connection
      </button>
    </div>
    <template x-if="testResults.openai">
      <div :class="tests.openai ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResults.openai"></div>
    </template>
  </div>

  <div class="card" style="padding: 0; box-shadow: none; border: 0; margin-top: 16px;">
    <h3 class="text-sm mb-2">Google Gemini</h3>
    <label class="label" for="w-google-key">Google API Key</label>
    <input type="password" class="input" id="w-google-key" placeholder="AIza..."
           value="{{ step_ctx.google_api_key|default('') }}">
    <p class="hint">Create a key in <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></p>
    <label class="label mt-2" for="w-google-base-url">Google Base URL (optional)</label>
    <input type="text" class="input" id="w-google-base-url" placeholder="https://generativelanguage.googleapis.com/v1beta/openai"
           value="{{ step_ctx.google_base_url|default('') }}">

    <div class="mt-3">
      <button class="btn" :disabled="testing"
              @click="
                testing = true;
                const provider = 'google';
                const apiKey = document.getElementById('w-google-key').value;
                const baseUrl = document.getElementById('w-google-base-url').value || 'https://generativelanguage.googleapis.com/v1beta/openai';
                fetch('/setup/test-connection', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({service: provider, api_key: apiKey, base_url: baseUrl})
                })
                .then(r => r.json())
                .then(d => {
                  tests[provider] = !!d.ok;
                  testResults[provider] = d.ok ? 'Connection successful' + (d.response ? ': ' + d.response : '') : d.error;
                })
                .catch(e => {
                  tests[provider] = false;
                  testResults[provider] = e.message;
                })
                .finally(() => { testing = false; })
              ">
        <span x-show="testing" class="spinner mr-1"></span>
        Test connection
      </button>
    </div>
    <template x-if="testResults.google">
      <div :class="tests.google ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResults.google"></div>
    </template>
  </div>

  <div class="card" style="padding: 0; box-shadow: none; border: 0; margin-top: 16px;">
    <h3 class="text-sm mb-2">Grok (xAI)</h3>
    <label class="label" for="w-grok-key">Grok API Key</label>
    <input type="password" class="input" id="w-grok-key" placeholder="xai-..."
           value="{{ step_ctx.grok_api_key|default('') }}">
    <p class="hint">Create a key in <a href="https://console.x.ai/" target="_blank">console.x.ai</a></p>
    <label class="label mt-2" for="w-grok-base-url">Grok Base URL (optional)</label>
    <input type="text" class="input" id="w-grok-base-url" placeholder="https://api.x.ai/v1"
           value="{{ step_ctx.grok_base_url|default('') }}">

    <div class="mt-3">
      <button class="btn" :disabled="testing"
              @click="
                testing = true;
                const provider = 'grok';
                const apiKey = document.getElementById('w-grok-key').value;
                const baseUrl = document.getElementById('w-grok-base-url').value || 'https://api.x.ai/v1';
                fetch('/setup/test-connection', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({service: provider, api_key: apiKey, base_url: baseUrl})
                })
                .then(r => r.json())
                .then(d => {
                  tests[provider] = !!d.ok;
                  testResults[provider] = d.ok ? 'Connection successful' + (d.response ? ': ' + d.response : '') : d.error;
                })
                .catch(e => {
                  tests[provider] = false;
                  testResults[provider] = e.message;
                })
                .finally(() => { testing = false; })
              ">
        <span x-show="testing" class="spinner mr-1"></span>
        Test connection
      </button>
    </div>
    <template x-if="testResults.grok">
      <div :class="tests.grok ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResults.grok"></div>
    </template>
  </div>

  <div class="card" style="padding: 0; box-shadow: none; border: 0; margin-top: 16px;">
    <h3 class="text-sm mb-2">DeepSeek</h3>
    <label class="label" for="w-deepseek-key">DeepSeek API Key</label>
    <input type="password" class="input" id="w-deepseek-key" placeholder="sk-..."
           value="{{ step_ctx.deepseek_api_key|default('') }}">
    <p class="hint">Create a key in <a href="https://platform.deepseek.com/api_keys" target="_blank">platform.deepseek.com</a></p>
    <label class="label mt-2" for="w-deepseek-base-url">DeepSeek Base URL (optional)</label>
    <input type="text" class="input" id="w-deepseek-base-url" placeholder="https://api.deepseek.com"
           value="{{ step_ctx.deepseek_base_url|default('') }}">

    <div class="mt-3">
      <button class="btn" :disabled="testing"
              @click="
                testing = true;
                const provider = 'deepseek';
                const apiKey = document.getElementById('w-deepseek-key').value;
                const baseUrl = document.getElementById('w-deepseek-base-url').value || 'https://api.deepseek.com';
                fetch('/setup/test-connection', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({service: provider, api_key: apiKey, base_url: baseUrl})
                })
                .then(r => r.json())
                .then(d => {
                  tests[provider] = !!d.ok;
                  testResults[provider] = d.ok ? 'Connection successful' + (d.response ? ': ' + d.response : '') : d.error;
                })
                .catch(e => {
                  tests[provider] = false;
                  testResults[provider] = e.message;
                })
                .finally(() => { testing = false; })
              ">
        <span x-show="testing" class="spinner mr-1"></span>
        Test connection
      </button>
    </div>
    <template x-if="testResults.deepseek">
      <div :class="tests.deepseek ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResults.deepseek"></div>
    </template>
  </div>

  <div class="flex justify-between mt-4">
    <button class="btn"
            hx-post="/setup/step" hx-target="#wizard-step" hx-swap="innerHTML"
            hx-vals='{"step": "welcome", "values": {}}'>
      Back
    </button>
    <button class="btn-primary"
            @click="
              const provider = document.getElementById('w-provider').value;
              const anthropicKey = document.getElementById('w-anthropic-key')?.value || '';
              const openaiKey = document.getElementById('w-openai-key')?.value || '';
              const openaiBaseUrl = document.getElementById('w-openai-base-url')?.value || '';
              const googleKey = document.getElementById('w-google-key')?.value || '';
              const googleBaseUrl = document.getElementById('w-google-base-url')?.value || '';
              const grokKey = document.getElementById('w-grok-key')?.value || '';
              const grokBaseUrl = document.getElementById('w-grok-base-url')?.value || '';
              const deepseekKey = document.getElementById('w-deepseek-key')?.value || '';
              const deepseekBaseUrl = document.getElementById('w-deepseek-base-url')?.value || '';
              const googleBaseUrlValue = googleBaseUrl || 'https://generativelanguage.googleapis.com/v1beta/openai';
              const grokBaseUrlValue = grokBaseUrl || 'https://api.x.ai/v1';
              const deepseekBaseUrlValue = deepseekBaseUrl || 'https://api.deepseek.com';
              htmx.ajax('POST', '/setup/step', {
                target: '#wizard-step', swap: 'innerHTML',
                values: {
                  step: 'identity',
                  'values[agent.llm_provider]': provider,
                  'values[agent.anthropic_api_key]': anthropicKey,
                  'values[agent.openai_api_key]': openaiKey,
                  'values[agent.openai_base_url]': openaiBaseUrl,
                  'values[agent.google_api_key]': googleKey,
                  'values[agent.google_base_url]': googleBaseUrlValue,
                  'values[agent.grok_api_key]': grokKey,
                  'values[agent.grok_base_url]': grokBaseUrlValue,
                  'values[agent.deepseek_api_key]': deepseekKey,
                  'values[agent.deepseek_base_url]': deepseekBaseUrlValue,
                  'values[agent.model]': document.getElementById('w-model').value
                }
              })
            ">
      Next
    </button>
  </div>
</div>
