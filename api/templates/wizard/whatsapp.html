<div class="card" x-data="{ testResult: '', testOk: false, testing: false }">
  <h2 class="text-base mb-3">WhatsApp <span class="text-muted font-normal text-xs">(optional)</span></h2>
  <p class="text-muted text-sm">WhatsApp runs locally via wacli. Use the admin UI to authenticate and sync.</p>

  <input type="hidden" id="w-wa-bridge" value="{{ step_ctx.bridge_url|default('local-wacli') }}">

  <div class="mt-3">
    <label class="label" for="w-wa-numbers">Allowed numbers</label>
    <input type="text" class="input" id="w-wa-numbers" placeholder="+14155551234, +442071838750"
           value="{{ step_ctx.allowed_numbers|default('') }}">
    <p class="hint">Comma-separated. Leave empty to allow any sender.</p>
  </div>



  <div class="mt-3">
      <button class="btn" :disabled="testing"
            @click="
              testing = true; testResult = '';
              fetch('/channels/whatsapp/test', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
                },
              body: JSON.stringify({ bridge_url: 'local-wacli' })
              })
              .then(r => r.json())
              .then(d => { testOk = d.ok; testResult = d.ok ? 'wacli available' : (d.error || 'wacli not available'); })
              .catch(e => { testOk = false; testResult = e.message; })
              .finally(() => { testing = false; })
            ">
      <span x-show="testing" class="spinner mr-1"></span>
      Test bridge
    </button>
  </div>
  <template x-if="testResult">
    <div :class="testOk ? 'alert-success' : 'alert-error'" class="mt-2" x-text="testResult"></div>
  </template>

  <div class="flex justify-between mt-4">
    <button class="btn"
            hx-post="/setup/step" hx-target="#wizard-step" hx-swap="innerHTML"
            hx-vals='{"step": "telegram", "values": {}}'>
      Back
    </button>
    <div class="flex gap-2">
      <button class="btn"
            @click="
              htmx.ajax('POST', '/setup/step', {
                target: '#wizard-step', swap: 'innerHTML',
                values: {
                  step: 'email',
                  'values[channels.whatsapp.enabled]': 'false'
                }
              })
            ">
      Skip
      </button>
      <button class="btn-primary"
              @click="
                htmx.ajax('POST', '/setup/step', {
                  target: '#wizard-step', swap: 'innerHTML',
                  values: {
                    step: 'email',
                    'values[channels.whatsapp.enabled]': 'true',
                    'values[channels.whatsapp.bridge_url]': document.getElementById('w-wa-bridge').value,
                    'values[channels.whatsapp.allowed_numbers]': document.getElementById('w-wa-numbers').value
                  }
                })
              ">
        Next
      </button>
    </div>
  </div>
</div>
