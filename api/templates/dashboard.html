{% extends "base.html" %}
{% block title %}Admin Dashboard — Agent Admin{% endblock %}

{% block body %}
<div>
  <h1 class="text-xl text-accent mb-2">Agent Admin</h1>

  {# Status bar — loaded via HTMX, refreshes on lifecycle events #}
  <div id="status-bar" class="flex items-center gap-3 py-2 mb-4 flex-wrap"
       hx-get="/partials/status" hx-trigger="load, refresh-status from:body" hx-swap="innerHTML">
    <span class="text-muted text-xs">Loading...</span>
  </div>

  {# Tab navigation #}
  <div class="flex border-b border-border mb-4" x-data="adminTabs()" x-init="init()">
    <button class="tab-link" :class="tab === 'config' && 'tab-link-active'"
            @click="select('config')">
      Config
    </button>
    <button class="tab-link" :class="tab === 'identity' && 'tab-link-active'"
            @click="select('identity')">
      Agent Identity
    </button>
    <button class="tab-link" :class="tab === 'permissions' && 'tab-link-active'"
            @click="select('permissions')">
      Permissions
    </button>
    <button class="tab-link" :class="tab === 'skills' && 'tab-link-active'"
            @click="select('skills')">
      Skills
    </button>
    <button class="tab-link" :class="tab === 'memory' && 'tab-link-active'"
            @click="select('memory')">
      Memory
    </button>
    <button class="tab-link" :class="tab === 'logs' && 'tab-link-active'"
            @click="select('logs')">
      Logs
    </button>
  </div>

  {# Tab content — initially loads config #}
  <div id="tab-content">
    <span class="text-muted text-xs">Loading...</span>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function adminTabs() {
    const tabs = {
      config: '/partials/config',
      identity: '/partials/identity',
      permissions: '/partials/permissions',
      skills: '/partials/skills',
      memory: '/partials/memory',
      logs: '/partials/logs'
    };

    return {
      tab: 'config',
      init() {
        const params = new URLSearchParams(window.location.search);
        const urlTab = params.get('tab');
        if (urlTab && tabs[urlTab]) {
          this.tab = urlTab;
        }
        this.loadTab(this.tab, false);
        if (!urlTab) {
          const url = new URL(window.location.href);
          url.searchParams.set('tab', this.tab);
          history.replaceState({tab: this.tab}, '', url);
        }

        window.addEventListener('popstate', () => {
          const current = new URLSearchParams(window.location.search).get('tab') || 'config';
          if (tabs[current]) {
            this.loadTab(current, false);
          }
        });
      },
      select(name) {
        this.loadTab(name, true);
      },
      loadTab(name, updateUrl) {
        if (!tabs[name] || this.tab === name && !updateUrl) {
          return;
        }
        this.tab = name;
        htmx.ajax('GET', tabs[name], {target: '#tab-content', swap: 'innerHTML'});
        if (updateUrl) {
          const url = new URL(window.location.href);
          url.searchParams.set('tab', name);
          history.pushState({tab: name}, '', url);
        }
      }
    };
  }
</script>
{% endblock %}
