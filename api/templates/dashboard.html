{% extends "base.html" %}
{% block title %}Admin Dashboard — Agent Admin{% endblock %}

{% block body %}
<div>
  <div class="flex items-center justify-between gap-3 mb-2 flex-wrap">
    <h1 class="text-xl text-accent">Agent Admin</h1>
  </div>

  {# Status bar — loaded via HTMX, refreshes on lifecycle events #}
  <div id="status-bar" class="flex items-center gap-3 py-2 mb-4 flex-wrap"
       hx-get="/partials/status" hx-trigger="load, refresh-status from:body" hx-swap="innerHTML">
    <span class="text-muted text-xs">Loading...</span>
  </div>

  <div id="agent-modal" class="fixed" style="inset: 0; background: rgba(0,0,0,0.65); display: none; align-items: center; justify-content: center; z-index: 50;">
    <div class="card" style="max-width: 520px; width: 100%;">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="text-base text-accent">Agent Control</h2>
          <p class="text-muted text-xs">Start, stop, or restart the agent. Status updates instantly.</p>
        </div>
        <button class="btn btn-sm" type="button" onclick="closeAgentModal()">Close</button>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <button class="btn btn-sm" hx-post="/agent/start" hx-target="#agent-modal-result" hx-swap="innerHTML">Start</button>
        <button class="btn-danger btn-sm" hx-post="/agent/stop" hx-target="#agent-modal-result" hx-swap="innerHTML"
                hx-confirm="Stop the agent?">Stop</button>
        <button class="btn btn-sm" hx-post="/agent/restart" hx-target="#agent-modal-result" hx-swap="innerHTML">Restart</button>
      </div>
      <div id="agent-modal-result" class="mt-3 text-xs"></div>
      <div class="mt-3 text-muted text-xs">
        Current status updates in the header badge; click it any time to manage the agent.
      </div>
    </div>
  </div>

  {# Tab navigation #}
  <div class="flex border-b border-border mb-4" x-data="adminTabs()" x-init="init()">
    <button class="tab-link" :class="tab === 'config' && 'tab-link-active'"
            @click="select('config')">
      Config
    </button>
    <button class="tab-link" :class="tab === 'identity' && 'tab-link-active'"
            @click="select('identity')">
      Agent Identity
    </button>
    <button class="tab-link" :class="tab === 'permissions' && 'tab-link-active'"
            @click="select('permissions')">
      Permissions
    </button>
    <button class="tab-link" :class="tab === 'skills' && 'tab-link-active'"
            @click="select('skills')">
      Skills
    </button>
    <button class="tab-link" :class="tab === 'channels' && 'tab-link-active'"
            @click="select('channels')">
      Channels
    </button>
    <button class="tab-link" :class="tab === 'memory' && 'tab-link-active'"
            @click="select('memory')">
      Memory
    </button>
    <button class="tab-link" :class="tab === 'jobs' && 'tab-link-active'"
            @click="select('jobs')">
      Jobs
    </button>
    <button class="tab-link" :class="tab === 'logs' && 'tab-link-active'"
            @click="select('logs')">
      Logs
    </button>
  </div>

  {# Tab content — initially loads config #}
  <div id="tab-content">
    <span class="text-muted text-xs">Loading...</span>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function openAgentModal() {
    const modal = document.getElementById('agent-modal');
    if (!modal) return;
    modal.style.display = 'flex';
  }

  function closeAgentModal() {
    const modal = document.getElementById('agent-modal');
    if (!modal) return;
    modal.style.display = 'none';
  }

  document.addEventListener('click', (event) => {
    const modal = document.getElementById('agent-modal');
    if (!modal || modal.style.display !== 'flex') return;
    if (event.target === modal) {
      closeAgentModal();
    }
  });

  document.addEventListener('keydown', (event) => {
    if (event.key !== 'Escape') return;
    const agentModal = document.getElementById('agent-modal');
    if (agentModal && agentModal.style.display === 'flex') {
      closeAgentModal();
    }
    const channelModal = document.getElementById('channel-modal');
    if (channelModal && channelModal.style.display === 'flex') {
      closeChannelWizard();
    }
  });

  function openChannelWizard(channelKey) {
    const modal = document.getElementById('channel-modal');
    if (!modal) return;
    modal.style.display = 'flex';
    if (channelKey) {
      loadChannelWizard(channelKey);
    }
  }

  function closeChannelWizard() {
    const modal = document.getElementById('channel-modal');
    if (!modal) return;
    modal.style.display = 'none';
  }

  function loadChannelWizard(channelKey) {
    const body = document.getElementById('channel-wizard-body');
    if (!body) return;
    body.innerHTML = '<span class="text-muted text-xs">Loading...</span>';
    fetch('/channels/wizard?channel=' + encodeURIComponent(channelKey), {
      headers: {
        'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
      }
    })
      .then(r => r.text())
      .then(html => { body.innerHTML = html; })
      .catch(e => { body.innerHTML = '<div class="alert-error">' + e.message + '</div>'; });
  }

  function removeChannel(channelKey) {
    if (!confirm('Remove ' + channelKey + ' channel configuration?')) return;
    fetch('/channels/' + encodeURIComponent(channelKey), {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
      }
    })
      .then(r => r.text())
      .then(html => {
        document.getElementById('tab-content').innerHTML = html;
      })
      .catch(e => alert(e.message));
  }

  document.addEventListener('click', (event) => {
    const modal = document.getElementById('channel-modal');
    if (!modal || modal.style.display !== 'flex') return;
    if (event.target === modal) {
      closeChannelWizard();
    }
  });


  function adminTabs() {
    const tabs = {
      config: '/partials/config',
      identity: '/partials/identity',
      permissions: '/partials/permissions',
      skills: '/partials/skills',
      channels: '/partials/channels',
      memory: '/partials/memory',
      jobs: '/partials/jobs',
      logs: '/partials/logs'
    };

    return {
      tab: 'config',
      init() {
        const params = new URLSearchParams(window.location.search);
        const urlTab = params.get('tab');
        if (urlTab && tabs[urlTab]) {
          this.tab = urlTab;
        }
        this.loadTab(this.tab, false);
        if (!urlTab) {
          const url = new URL(window.location.href);
          url.searchParams.set('tab', this.tab);
          history.replaceState({tab: this.tab}, '', url);
        }

        window.addEventListener('popstate', () => {
          const current = new URLSearchParams(window.location.search).get('tab') || 'config';
          if (tabs[current]) {
            this.loadTab(current, false);
          }
        });
      },
      select(name) {
        this.loadTab(name, true);
      },
      loadTab(name, updateUrl) {
        if (!tabs[name] || this.tab === name && !updateUrl) {
          return;
        }
        this.tab = name;
        htmx.ajax('GET', tabs[name], {target: '#tab-content', swap: 'innerHTML'});
        if (updateUrl) {
          const url = new URL(window.location.href);
          url.searchParams.set('tab', name);
          history.pushState({tab: name}, '', url);
        }
      }
    };
  }
</script>
{% endblock %}
