{% extends "base.html" %}
{% block title %}Admin Dashboard — Agent Admin{% endblock %}

{% block body %}
<div>
  <div class="flex items-center justify-between gap-3 mb-2 flex-wrap">
    <h1 class="text-xl text-accent" id="admin-greeting" data-owner="{{ owner_name|default('', true)|e }}" data-agent="{{ agent_name|default('', true)|e }}">
      Hi there! Let's configure your assistant...
    </h1>
  </div>

  {# Status bar — loaded via HTMX, refreshes on lifecycle events #}
  <div id="status-bar" class="flex items-center gap-3 py-2 mb-4 flex-wrap"
       hx-get="/partials/status" hx-trigger="load, refresh-status from:body" hx-swap="innerHTML">
    <span class="text-muted text-xs">Loading...</span>
  </div>

  <div id="agent-modal" class="fixed" style="inset: 0; background: rgba(0,0,0,0.65); display: none; align-items: center; justify-content: center; z-index: 50;">
    <div class="card" style="max-width: 520px; width: 100%;"
         x-data="agentControl()" x-init="init()">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="text-base text-accent">Agent Control</h2>
          <p class="text-muted text-xs">Start, stop, or restart the agent. Status updates instantly.</p>
        </div>
        <button class="btn btn-sm" type="button" onclick="closeAgentModal()">Close</button>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <button class="btn btn-sm" :disabled="busy" @click="run('start')">
          <span x-show="action === 'start'" class="spinner" style="width: 12px; height: 12px; display: none;"></span>
          Start
        </button>
        <button class="btn-danger btn-sm" :disabled="busy" @click="run('stop', true)">
          <span x-show="action === 'stop'" class="spinner" style="width: 12px; height: 12px; display: none;"></span>
          Stop
        </button>
        <button class="btn btn-sm" :disabled="busy" @click="run('restart')">
          <span x-show="action === 'restart'" class="spinner" style="width: 12px; height: 12px; display: none;"></span>
          Restart
        </button>
      </div>
      <div id="agent-modal-result" class="mt-3 text-xs">
        <template x-if="result">
          <span :class="ok ? 'alert-success' : 'alert-error'" x-text="result"></span>
        </template>
      </div>
      <div class="mt-3 text-muted text-xs">
        Current status updates in the header badge; click it any time to manage the agent.
      </div>
    </div>
  </div>

  {# Tab navigation #}
  <div class="flex border-b border-border mb-4 overflow-x-auto" x-data="adminTabs()" x-init="init()">
    <button class="tab-link" :class="tab === 'identity' && 'tab-link-active'"
            @click="select('identity')">
      Assistant
    </button>
    <button class="tab-link" :class="tab === 'you' && 'tab-link-active'"
            @click="select('you')">
      You
    </button>
    <button class="tab-link" :class="tab === 'llm' && 'tab-link-active'"
            @click="select('llm')">
      LLM
    </button>
    <button class="tab-link" :class="tab === 'channels' && 'tab-link-active'"
            @click="select('channels')">
      Channels
    </button>
    <button class="tab-link" :class="tab === 'memory' && 'tab-link-active'"
            @click="select('memory')">
      Memory
    </button>
    <button class="tab-link" :class="tab === 'search' && 'tab-link-active'"
            @click="select('search')">
      Search
    </button>
    <button class="tab-link" :class="tab === 'permissions' && 'tab-link-active'"
            @click="select('permissions')">
      Permissions
    </button>
    <button class="tab-link" :class="tab === 'skills' && 'tab-link-active'"
            @click="select('skills')">
      Skills
    </button>
    <button class="tab-link" :class="tab === 'jobs' && 'tab-link-active'"
            @click="select('jobs')">
      Jobs
    </button>
    <button class="tab-link" :class="tab === 'calendars' && 'tab-link-active'"
            @click="select('calendars')">
      Calendars
    </button>
    <button class="tab-link" :class="tab === 'email' && 'tab-link-active'"
            @click="select('email')">
      Email
    </button>
    <button class="tab-link" :class="tab === 'history' && 'tab-link-active'"
            @click="select('history')">
      History
    </button>
    <button class="tab-link" :class="tab === 'logs' && 'tab-link-active'"
            @click="select('logs')">
      Logs
    </button>
    <button class="tab-link" :class="tab === 'admin' && 'tab-link-active'"
            @click="select('admin')">
      Admin
    </button>
    <button class="tab-link" :class="tab === 'config' && 'tab-link-active'"
            @click="select('config')">
      Config
    </button>
  </div>

  {# Tab content — initially loads config #}
  <div id="tab-content">
    <span class="text-muted text-xs">Loading...</span>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function agentControl() {
    return {
      busy: false,
      action: '',
      result: '',
      ok: false,
      init() {
        // Reset result when modal is reopened
        const modal = document.getElementById('agent-modal');
        if (modal) {
          const observer = new MutationObserver(() => {
            if (modal.style.display === 'flex' && !this.busy) {
              this.result = '';
            }
          });
          observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
        }
      },
      async run(act, confirm = false) {
        if (confirm && !window.confirm('Stop the agent?')) return;
        this.busy = true;
        this.action = act;
        this.result = '';
        // Immediately refresh the status bar so the user sees STARTING/STOPPING/RESTARTING
        document.body.dispatchEvent(new CustomEvent('refresh-status'));
        const key = localStorage.getItem('admin_api_key') || '';
        try {
          const resp = await fetch('/agent/' + act, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + key }
          });
          const data = await resp.json();
          const status = data.status || '';
          if (['started', 'already_running', 'stopped', 'not_running', 'restarted'].includes(status)) {
            this.ok = true;
            this.result = status.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
          } else {
            this.ok = false;
            this.result = data.error || status;
          }
        } catch (e) {
          this.ok = false;
          this.result = e.message || 'Request failed';
        } finally {
          this.busy = false;
          this.action = '';
          // Refresh status bar with final state
          document.body.dispatchEvent(new CustomEvent('refresh-status'));
        }
      }
    };
  }

  function openAgentModal() {
    const modal = document.getElementById('agent-modal');
    if (!modal) return;
    modal.style.display = 'flex';
  }

  function closeAgentModal() {
    const modal = document.getElementById('agent-modal');
    if (!modal) return;
    modal.style.display = 'none';
  }

  document.addEventListener('click', (event) => {
    const modal = document.getElementById('agent-modal');
    if (!modal || modal.style.display !== 'flex') return;
    if (event.target === modal) {
      closeAgentModal();
    }
  });

  function updateAdminGreeting(ownerName, agentName) {
    const el = document.getElementById('admin-greeting');
    if (!el) return;
    const currentOwner = ownerName || el.dataset.owner || '';
    const currentAgent = agentName || el.dataset.agent || '';
    const owner = (currentOwner || 'there').trim();
    const agent = (currentAgent || 'your assistant').trim();
    el.dataset.owner = currentOwner;
    el.dataset.agent = currentAgent;
    el.textContent = `Hi ${owner}! Let's configure ${agent}...`;
  }

  document.addEventListener('keydown', (event) => {
    if (event.key !== 'Escape') return;
    const agentModal = document.getElementById('agent-modal');
    if (agentModal && agentModal.style.display === 'flex') {
      closeAgentModal();
    }
    const channelModal = document.getElementById('channel-modal');
    if (channelModal && channelModal.style.display === 'flex') {
      closeChannelWizard();
    }
  });

  function openChannelWizard(channelKey) {
    const modal = document.getElementById('channel-modal');
    if (!modal) return;
    resetChannelWizard();
    modal.style.display = 'flex';
    if (channelKey) {
      loadChannelWizard(channelKey);
    }
  }

  function closeChannelWizard() {
    const modal = document.getElementById('channel-modal');
    if (!modal) return;
    modal.style.display = 'none';
    resetChannelWizard();
  }

  function resetChannelWizard() {
    const body = document.getElementById('channel-wizard-body');
    const selector = document.getElementById('channel-wizard-selector');
    if (!body || !selector) return;
    body.innerHTML = selector.innerHTML;
  }

  function loadChannelWizard(channelKey) {
    const body = document.getElementById('channel-wizard-body');
    if (!body) return;
    body.innerHTML = '<span class="text-muted text-xs">Loading...</span>';
    fetch('/channels/wizard?channel=' + encodeURIComponent(channelKey), {
      headers: {
        'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
      }
    })
      .then(r => r.text())
      .then(html => { body.innerHTML = html; })
      .catch(e => { body.innerHTML = '<div class="alert-error">' + e.message + '</div>'; });
  }

  function removeChannel(channelKey) {
    if (!confirm('Remove ' + channelKey + ' channel configuration?')) return;
    fetch('/channels/' + encodeURIComponent(channelKey), {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
      }
    })
      .then(r => r.text())
      .then(html => {
        document.getElementById('tab-content').innerHTML = html;
      })
      .catch(e => alert(e.message));
  }

  function testTelegram() {
    const result = document.getElementById('channel-wizard-result');
    const tokenInput = document.getElementById('ch-tg-token');
    if (!result || !tokenInput) return;
    const token = tokenInput.value.trim();
    result.textContent = 'Testing...';
    result.className = 'alert-info';
    fetch('/setup/test-connection', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
      },
      body: JSON.stringify({service: 'telegram', bot_token: token})
    })
      .then(r => r.json())
      .then(d => {
        result.textContent = d.ok ? 'Connected to @' + (d.bot_username || '') : d.error;
        result.className = d.ok ? 'alert-success' : 'alert-error';
      })
      .catch(e => {
        result.textContent = e.message;
        result.className = 'alert-error';
      });
  }

  function saveTelegram() {
    const result = document.getElementById('channel-wizard-result');
    const tokenInput = document.getElementById('ch-tg-token');
    const usersInput = document.getElementById('ch-tg-users');
    if (!result || !tokenInput || !usersInput) return;
    const token = tokenInput.value.trim();
    const users = usersInput.value.trim();
    if (!token) {
      result.textContent = 'Bot token is required.';
      result.className = 'alert-error';
      return;
    }
    fetch('/channels/telegram', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + (localStorage.getItem('admin_api_key') || '')
      },
      body: JSON.stringify({bot_token: token, user_ids: users, enabled: true})
    })
      .then(r => r.text())
      .then(html => {
        document.getElementById('tab-content').innerHTML = html;
        closeChannelWizard();
        if (window.showToast) { window.showToast('Telegram channel saved'); }
      })
      .catch(e => {
        result.textContent = e.message;
        result.className = 'alert-error';
      });
  }

  document.addEventListener('click', (event) => {
    const modal = document.getElementById('channel-modal');
    if (!modal || modal.style.display !== 'flex') return;
    if (event.target === modal) {
      closeChannelWizard();
    }
  });


  function adminTabs() {
    const tabs = {
      identity: '/partials/identity',
      you: '/partials/you',
      llm: '/partials/llm',
      channels: '/partials/channels',
      memory: '/partials/memory',
      search: '/partials/search',
      permissions: '/partials/permissions',
      skills: '/partials/skills',
      jobs: '/partials/jobs',
      calendars: '/partials/calendars',
      email: '/partials/email',
      history: '/partials/history',
      logs: '/partials/logs',
      admin: '/partials/admin',
      config: '/partials/config'
    };

    return {
      tab: null,
      init() {
        const params = new URLSearchParams(window.location.search);
        const urlTab = params.get('tab');
        const initialTab = (urlTab && tabs[urlTab]) ? urlTab : 'identity';
        this.tab = initialTab;
        const greeting = document.getElementById('admin-greeting');
        if (greeting) {
          const ownerName = greeting.dataset.owner || '';
          const agentName = greeting.dataset.agent || '';
          updateAdminGreeting(ownerName, agentName);
        }
        if (!urlTab) {
          const url = new URL(window.location.href);
          url.searchParams.set('tab', initialTab);
          history.replaceState({tab: initialTab}, '', url);
        }
        // Defer the initial HTMX fetch so both Alpine and HTMX are fully
        // initialised before the request fires.
        this.$nextTick(() => {
          htmx.ajax('GET', tabs[initialTab], {target: '#tab-content', swap: 'innerHTML'});
        });

        window.addEventListener('popstate', () => {
          const current = new URLSearchParams(window.location.search).get('tab') || 'identity';
          if (tabs[current]) {
            this.loadTab(current, false);
          }
        });
      },
      select(name) {
        this.loadTab(name, true);
      },
      loadTab(name, updateUrl) {
        if (!tabs[name] || this.tab === name && !updateUrl) {
          return;
        }
        this.tab = name;
        htmx.ajax('GET', tabs[name], {target: '#tab-content', swap: 'innerHTML'});
        if (updateUrl) {
          const url = new URL(window.location.href);
          url.searchParams.set('tab', name);
          history.pushState({tab: name}, '', url);
        }
      }
    };
  }
</script>
{% endblock %}
