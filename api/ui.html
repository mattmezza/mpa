<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Agent Admin</title>
<style>
  :root {
    --bg: #0a0a0a; --fg: #e0e0e0; --muted: #888;
    --accent: #6c9; --accent-dim: #4a7a5a;
    --surface: #151515; --border: #2a2a2a;
    --danger: #c66; --warn: #ca6;
    --radius: 6px; --gap: 1rem;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', monospace;
    font-size: 14px; line-height: 1.6;
    background: var(--bg); color: var(--fg);
    max-width: 720px; margin: 0 auto; padding: 2rem 1rem;
  }
  h1 { font-size: 1.4rem; margin-bottom: 0.5rem; color: var(--accent); }
  h2 { font-size: 1.1rem; margin: 1.5rem 0 0.5rem; color: var(--fg); border-bottom: 1px solid var(--border); padding-bottom: 0.3rem; }
  h3 { font-size: 0.95rem; margin: 1rem 0 0.3rem; color: var(--muted); }

  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 3px;
    font-size: 0.75rem; font-weight: bold; text-transform: uppercase;
  }
  .badge-ok { background: var(--accent-dim); color: #fff; }
  .badge-warn { background: #6a5a2a; color: var(--warn); }
  .badge-off { background: #333; color: var(--muted); }

  label { display: block; margin: 0.6rem 0 0.2rem; color: var(--muted); font-size: 0.85rem; }
  input[type="text"], input[type="password"], input[type="number"], select, textarea {
    width: 100%; padding: 0.5rem; background: var(--surface);
    border: 1px solid var(--border); color: var(--fg); border-radius: var(--radius);
    font-family: inherit; font-size: 0.9rem;
  }
  input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); }
  textarea { resize: vertical; min-height: 60px; }
  .hint { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }

  button, .btn {
    display: inline-block; padding: 0.5rem 1rem; border: 1px solid var(--border);
    background: var(--surface); color: var(--fg); border-radius: var(--radius);
    font-family: inherit; font-size: 0.85rem; cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
  }
  button:hover, .btn:hover { border-color: var(--accent); background: #1a1a1a; }
  button.primary { background: var(--accent-dim); border-color: var(--accent); color: #fff; }
  button.primary:hover { background: var(--accent); color: #000; }
  button.danger { border-color: var(--danger); color: var(--danger); }
  button.danger:hover { background: var(--danger); color: #fff; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-row { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
  .btn-row.right { justify-content: flex-end; }

  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: var(--gap); margin: var(--gap) 0;
  }

  .test-result {
    padding: 0.4rem 0.6rem; border-radius: var(--radius); margin-top: 0.5rem;
    font-size: 0.85rem;
  }
  .test-ok { background: #1a2a1a; color: var(--accent); border: 1px solid var(--accent-dim); }
  .test-err { background: #2a1a1a; color: var(--danger); border: 1px solid #5a2a2a; }

  .step { display: none; }
  .step.active { display: block; }

  .progress { display: flex; gap: 4px; margin: 1rem 0; flex-wrap: wrap; }
  .progress-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--border); transition: background 0.2s;
  }
  .progress-dot.done { background: var(--accent); }
  .progress-dot.current { background: var(--warn); }

  /* Admin tabs */
  .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 1rem; }
  .tab {
    padding: 0.5rem 1rem; cursor: pointer; color: var(--muted);
    border-bottom: 2px solid transparent; transition: all 0.15s;
    font-size: 0.85rem;
  }
  .tab:hover { color: var(--fg); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  th { text-align: left; color: var(--muted); padding: 0.3rem 0.5rem; border-bottom: 1px solid var(--border); }
  td { padding: 0.3rem 0.5rem; border-bottom: 1px solid var(--border); word-break: break-all; }
  tr:hover td { background: #1a1a1a; }

  .log-viewer {
    background: #050505; border: 1px solid var(--border); border-radius: var(--radius);
    padding: 0.5rem; height: 400px; overflow-y: auto; font-size: 0.8rem;
    line-height: 1.4; white-space: pre-wrap; word-break: break-all;
  }

  .status-bar {
    display: flex; align-items: center; gap: 1rem;
    padding: 0.5rem 0; margin-bottom: 1rem; flex-wrap: wrap;
  }

  .hidden { display: none !important; }
  .mt { margin-top: 1rem; }
  .mb { margin-bottom: 1rem; }
</style>
</head>
<body>

<div id="app">
  <!-- Setup wizard -->
  <div id="wizard" class="hidden">
    <h1>Agent Setup</h1>
    <div class="progress" id="progress"></div>

    <!-- Step: welcome -->
    <div class="step" data-step="welcome">
      <div class="card">
        <h2>Welcome</h2>
        <p>This wizard will guide you through configuring your personal AI agent.</p>
        <p class="mt" style="color:var(--muted)">You'll set up:</p>
        <ul style="margin:0.5rem 0 0 1.5rem; color:var(--muted)">
          <li>LLM provider (Anthropic API key)</li>
          <li>Agent identity (name, owner, timezone)</li>
          <li>Telegram bot connection</li>
          <li>Email accounts (optional)</li>
          <li>Calendar providers (optional)</li>
          <li>Web search (optional)</li>
          <li>Admin API key</li>
        </ul>
        <div class="btn-row right mt">
          <button class="primary" onclick="wizardNext()">Get started</button>
        </div>
      </div>
    </div>

    <!-- Step: llm -->
    <div class="step" data-step="llm">
      <div class="card">
        <h2>LLM Provider</h2>
        <label for="w-api-key">Anthropic API Key</label>
        <input type="password" id="w-api-key" placeholder="sk-ant-...">
        <div class="hint">Get one at <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--accent)">console.anthropic.com</a></div>

        <label for="w-model">Model</label>
        <select id="w-model">
          <option value="claude-sonnet-4-5-20250514">Claude Sonnet 4.5</option>
          <option value="claude-haiku-4-5">Claude Haiku 4.5 (cheaper)</option>
        </select>

        <div class="btn-row mt">
          <button onclick="testConnection('anthropic', {'api_key': el('w-api-key').value})">Test connection</button>
        </div>
        <div id="test-anthropic"></div>

        <div class="btn-row right mt">
          <button onclick="wizardBack()">Back</button>
          <button class="primary" onclick="wizardSave('llm', {'agent.anthropic_api_key': el('w-api-key').value, 'agent.model': el('w-model').value})">Next</button>
        </div>
      </div>
    </div>

    <!-- Step: identity -->
    <div class="step" data-step="identity">
      <div class="card">
        <h2>Agent Identity</h2>
        <label for="w-name">Agent name</label>
        <input type="text" id="w-name" value="Clio" placeholder="Jarvis, Friday, ...">

        <label for="w-owner">Your name</label>
        <input type="text" id="w-owner" placeholder="Your Name">

        <label for="w-tz">Timezone</label>
        <input type="text" id="w-tz" value="Europe/Zurich" placeholder="Europe/Zurich">

        <div class="btn-row right mt">
          <button onclick="wizardBack()">Back</button>
          <button class="primary" onclick="wizardSaveIdentity()">Next</button>
        </div>
      </div>
    </div>

    <!-- Step: telegram -->
    <div class="step" data-step="telegram">
      <div class="card">
        <h2>Telegram</h2>
        <label for="w-tg-token">Bot Token</label>
        <input type="password" id="w-tg-token" placeholder="123456:ABC-DEF...">
        <div class="hint">Create a bot via <a href="https://t.me/BotFather" target="_blank" style="color:var(--accent)">@BotFather</a> on Telegram</div>

        <label for="w-tg-users">Your Telegram User ID</label>
        <input type="text" id="w-tg-users" placeholder="123456789">
        <div class="hint">Send /start to <a href="https://t.me/userinfobot" target="_blank" style="color:var(--accent)">@userinfobot</a> to find your ID</div>

        <div class="btn-row mt">
          <button onclick="testConnection('telegram', {'bot_token': el('w-tg-token').value})">Test connection</button>
        </div>
        <div id="test-telegram"></div>

        <div class="btn-row right mt">
          <button onclick="wizardBack()">Back</button>
          <button class="primary" onclick="wizardSave('telegram', {'channels.telegram.enabled': 'true', 'channels.telegram.bot_token': el('w-tg-token').value, 'channels.telegram.allowed_user_ids': el('w-tg-users').value})">Next</button>
        </div>
      </div>
    </div>

    <!-- Step: email -->
    <div class="step" data-step="email">
      <div class="card">
        <h2>Email (optional)</h2>
        <p style="color:var(--muted)">Email is managed via Himalaya CLI config files. You can set this up later by editing <code>cli-configs/himalaya.toml</code>.</p>
        <div class="btn-row right mt">
          <button onclick="wizardBack()">Back</button>
          <button onclick="wizardSave('email', {})">Skip</button>
          <button class="primary" onclick="wizardSave('email', {})">Next</button>
        </div>
      </div>
    </div>

    <!-- Step: calendar -->
    <div class="step" data-step="calendar">
      <div class="card">
        <h2>Calendar (optional)</h2>
        <label for="w-cal-name">Calendar name</label>
        <input type="text" id="w-cal-name" placeholder="google">

        <label for="w-cal-url">CalDAV URL</label>
        <input type="text" id="w-cal-url" placeholder="https://apidata.googleusercontent.com/caldav/v2/you@gmail.com/events">

        <label for="w-cal-user">Username / email</label>
        <input type="text" id="w-cal-user" placeholder="you@gmail.com">

        <label for="w-cal-pass">App password</label>
        <input type="password" id="w-cal-pass" placeholder="xxxx xxxx xxxx xxxx">
        <div class="hint">Use an App Password, not your regular password</div>

        <div class="btn-row right mt">
          <button onclick="wizardBack()">Back</button>
          <button onclick="wizardSave('calendar', {})">Skip</button>
          <button class="primary" onclick="wizardSaveCalendar()">Next</button>
        </div>
      </div>
    </div>

    <!-- Step: search -->
    <div class="step" data-step="search">
      <div class="card">
        <h2>Web Search (optional)</h2>
        <label for="w-tavily-key">Tavily API Key</label>
        <input type="password" id="w-tavily-key" placeholder="tvly-...">
        <div class="hint">Free tier at <a href="https://app.tavily.com" target="_blank" style="color:var(--accent)">app.tavily.com</a></div>

        <div class="btn-row mt">
          <button onclick="testConnection('tavily', {'api_key': el('w-tavily-key').value})">Test connection</button>
        </div>
        <div id="test-tavily"></div>

        <div class="btn-row right mt">
          <button onclick="wizardBack()">Back</button>
          <button onclick="wizardSave('search', {})">Skip</button>
          <button class="primary" onclick="wizardSave('search', {'search.enabled': el('w-tavily-key').value ? 'true' : 'false', 'search.api_key': el('w-tavily-key').value, 'search.provider': 'tavily'})">Next</button>
        </div>
      </div>
    </div>

    <!-- Step: admin -->
    <div class="step" data-step="admin">
      <div class="card">
        <h2>Admin API Key</h2>
        <p style="color:var(--muted)">Set a key to protect the admin API. You'll need this to access the dashboard after setup.</p>
        <label for="w-admin-key">API Key</label>
        <input type="password" id="w-admin-key">
        <div class="btn-row mt">
          <button onclick="generateKey()">Generate random key</button>
        </div>

        <div class="btn-row right mt">
          <button onclick="wizardBack()">Back</button>
          <button class="primary" onclick="wizardSave('admin', {'admin.api_key': el('w-admin-key').value, 'admin.enabled': 'true'})">Next</button>
        </div>
      </div>
    </div>

    <!-- Step: done -->
    <div class="step" data-step="done">
      <div class="card">
        <h2>Setup complete</h2>
        <p>Your agent is configured. Restart the process to boot with the new config.</p>
        <div class="btn-row mt">
          <button class="primary" onclick="finishSetup()">Start agent</button>
        </div>
        <div id="start-result" class="mt"></div>
      </div>
    </div>
  </div>

  <!-- Admin dashboard -->
  <div id="dashboard" class="hidden">
    <h1>Agent Admin</h1>
    <div class="status-bar" id="status-bar"></div>

    <div class="tabs">
      <div class="tab active" data-tab="config" onclick="switchTab('config')">Config</div>
      <div class="tab" data-tab="character" onclick="switchTab('character')">Agent identity</div>
      <div class="tab" data-tab="permissions" onclick="switchTab('permissions')">Permissions</div>
      <div class="tab" data-tab="memory" onclick="switchTab('memory')">Memory</div>
      <div class="tab" data-tab="logs" onclick="switchTab('logs')">Logs</div>
    </div>

    <!-- Config tab -->
    <div class="tab-panel active" data-tab="config">
      <div class="btn-row mb" style="align-items:end">
        <button onclick="loadConfig()">Refresh</button>
        <input type="text" id="cfg-search" placeholder="Filter keys..." oninput="filterConfig()" style="flex:1;min-width:150px;max-width:300px;margin:0">
      </div>
      <div id="config-table"></div>

      <h3 class="mt">Add / edit config</h3>
      <div style="display:flex;gap:0.5rem;align-items:end;flex-wrap:wrap">
        <div style="flex:1;min-width:150px">
          <label for="cfg-key">Key</label>
          <input type="text" id="cfg-key" placeholder="agent.name">
        </div>
        <div style="flex:2;min-width:200px">
          <label for="cfg-val">Value</label>
          <input type="text" id="cfg-val" placeholder="Jarvis">
        </div>
        <button onclick="updateConfig()">Save</button>
        <button id="cfg-cancel" class="hidden" onclick="cancelEditConfig()">Cancel</button>
      </div>
      <div id="cfg-result" class="mt"></div>

      <h3 class="mt">Agent control</h3>
      <div class="btn-row">
        <button onclick="agentAction('start')">Start</button>
        <button onclick="agentAction('stop')" class="danger">Stop</button>
        <button onclick="agentAction('restart')">Restart</button>
      </div>
      <div id="agent-result" class="mt"></div>
    </div>

    <!-- Character tab -->
    <div class="tab-panel" data-tab="character">
      <div class="card">
        <h2>Character</h2>
        <p style="color:var(--muted);margin-bottom:0.5rem">Defines <em>how</em> the agent behaves — tone, decision-making style, language rules. Markdown format.</p>
        <textarea id="char-editor" style="min-height:300px;font-size:0.85rem;line-height:1.5;tab-size:2"></textarea>
        <div class="btn-row right mt">
          <button class="primary" onclick="saveCharacter()">Save character</button>
        </div>
        <div id="char-result" class="mt"></div>
      </div>

      <div class="card">
        <h2>Personalia</h2>
        <p style="color:var(--muted);margin-bottom:0.5rem">Defines <em>what</em> the agent is — identity, capabilities, limitations, history. Markdown format.</p>
        <textarea id="pers-editor" style="min-height:300px;font-size:0.85rem;line-height:1.5;tab-size:2"></textarea>
        <div class="btn-row right mt">
          <button class="primary" onclick="savePersonalia()">Save personalia</button>
        </div>
        <div id="pers-result" class="mt"></div>
      </div>
    </div>

    <!-- Permissions tab -->
    <div class="tab-panel" data-tab="permissions">
      <div class="btn-row mb">
        <button onclick="loadPermissions()">Refresh</button>
      </div>
      <div id="perm-table"></div>

      <h3 class="mt">Add / update rule</h3>
      <div style="display:flex;gap:0.5rem;align-items:end;flex-wrap:wrap">
        <div style="flex:2;min-width:200px">
          <label for="perm-pattern">Pattern</label>
          <input type="text" id="perm-pattern" placeholder="run_command:himalaya*send*">
        </div>
        <div style="flex:1;min-width:100px">
          <label for="perm-level">Level</label>
          <select id="perm-level">
            <option>ALWAYS</option>
            <option selected>ASK</option>
            <option>NEVER</option>
          </select>
        </div>
        <button onclick="addPermission()">Save</button>
      </div>
    </div>

    <!-- Memory tab -->
    <div class="tab-panel" data-tab="memory">
      <div class="btn-row mb">
        <button onclick="loadMemory()">Refresh</button>
        <button onclick="triggerConsolidation()">Run consolidation</button>
      </div>
      <h3>Long-term</h3>
      <div id="lt-table"></div>
      <h3 class="mt">Short-term (active)</h3>
      <div id="st-table"></div>
    </div>

    <!-- Logs tab -->
    <div class="tab-panel" data-tab="logs">
      <div class="btn-row mb">
        <button onclick="loadLogs()">Refresh</button>
        <label style="display:inline;margin:0;color:var(--muted)">
          <input type="checkbox" id="log-auto" onchange="toggleAutoLogs()"> Auto-refresh
        </label>
      </div>
      <div class="log-viewer" id="log-viewer"></div>
    </div>
  </div>

  <!-- Auth gate (when setup is complete but no token provided) -->
  <div id="auth-gate" class="hidden">
    <h1>Agent Admin</h1>
    <div class="card">
      <h2>Authentication</h2>
      <label for="auth-key">Admin API Key</label>
      <input type="password" id="auth-key" placeholder="Enter your admin API key">
      <div class="btn-row right mt">
        <button class="primary" onclick="authenticate()">Log in</button>
      </div>
      <div id="auth-error" class="mt"></div>
    </div>
  </div>
</div>

<script>
// --- State ---
let apiKey = localStorage.getItem('admin_api_key') || '';
let setupSteps = [];
let currentStep = 'welcome';
let logInterval = null;

const el = id => document.getElementById(id);

// --- API helpers ---
async function api(method, path, body) {
  const opts = { method, headers: {} };
  if (apiKey) opts.headers['Authorization'] = `Bearer ${apiKey}`;
  if (body !== undefined) {
    opts.headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(body);
  }
  const r = await fetch(path, opts);
  if (r.status === 401) {
    showView('auth-gate');
    throw new Error('Unauthorized');
  }
  const data = await r.json();
  if (!r.ok) {
    throw new Error(data.detail || `Request failed (${r.status})`);
  }
  return data;
}

// --- Views ---
function showView(id) {
  ['wizard', 'dashboard', 'auth-gate'].forEach(v => {
    el(v).classList.toggle('hidden', v !== id);
  });
}

// --- Init ---
async function init() {
  try {
    const status = await api('GET', '/setup/status');
    setupSteps = status.steps;
    if (!status.complete) {
      currentStep = status.current_step;
      showView('wizard');
      renderWizard();
    } else {
      // Try to load config to verify auth
      try {
        await api('GET', '/health');
        showView('dashboard');
        loadDashboard();
      } catch {
        showView('auth-gate');
      }
    }
  } catch {
    showView('auth-gate');
  }
}

// --- Wizard ---
function renderWizard() {
  // Progress dots
  const prog = el('progress');
  prog.innerHTML = setupSteps.map(s => {
    const idx = setupSteps.indexOf(s);
    const curIdx = setupSteps.indexOf(currentStep);
    let cls = 'progress-dot';
    if (idx < curIdx) cls += ' done';
    if (idx === curIdx) cls += ' current';
    return `<div class="${cls}" title="${s}"></div>`;
  }).join('');

  // Show correct step
  document.querySelectorAll('.step').forEach(s => {
    s.classList.toggle('active', s.dataset.step === currentStep);
  });
}

function wizardNext() {
  const idx = setupSteps.indexOf(currentStep);
  if (idx < setupSteps.length - 1) {
    currentStep = setupSteps[idx + 1];
    renderWizard();
  }
}

function wizardBack() {
  const idx = setupSteps.indexOf(currentStep);
  if (idx > 0) {
    currentStep = setupSteps[idx - 1];
    renderWizard();
  }
}

async function wizardSave(step, values) {
  const nextIdx = setupSteps.indexOf(currentStep) + 1;
  const nextStep = nextIdx < setupSteps.length ? setupSteps[nextIdx] : 'done';
  await api('POST', '/setup/step', { step: nextStep, values });
  currentStep = nextStep;
  renderWizard();
}

async function wizardSaveCalendar() {
  const name = el('w-cal-name').value.trim();
  const url = el('w-cal-url').value.trim();
  const user = el('w-cal-user').value.trim();
  const pass = el('w-cal-pass').value.trim();

  const values = {};
  if (name && url) {
    values[`calendar.providers`] = JSON.stringify([{name, url, username: user, password: pass}]);
  }
  await wizardSave('calendar', values);
}

async function wizardSaveIdentity() {
  const agentName = el('w-name').value.trim() || 'Clio';
  const ownerName = el('w-owner').value.trim() || 'User';

  const values = {
    'agent.name': agentName,
    'agent.owner_name': ownerName,
    'agent.timezone': el('w-tz').value.trim() || 'UTC',
  };

  // Seed default character and personalia with the chosen names
  values['agent.character'] = [
    '# Character',
    '',
    '## Tone',
    '',
    '- Be concise. Messages should be short and direct — no filler.',
    '- Be warm but not sycophantic. No "Great question!" or "Of course!". Just answer.',
    `- When acting on ${ownerName}'s behalf (emails, messages), match their communication style.`,
    `- When messaging ${ownerName}'s contacts, always identify yourself unless told otherwise.`,
    '',
    '## Decision-making',
    '',
    '- When unsure about an action, ask. When confident and pre-approved, just do it.',
    '- If multiple contacts match a name, present the options — never guess.',
    '- If a command fails, read the error and try to fix it before reporting back.',
    '- Prefer structured data (JSON output flags) over free-text parsing when available.',
    '',
    '## Language',
    '',
    '- Default to English.',
    '',
    '## Proactive behaviors',
    '',
    'When running scheduled tasks (morning briefing, email checks):',
    '- Be brief and scannable.',
    '- Only flag truly important items.',
    '- Group related information together.',
  ].join('\n');

  values['agent.personalia'] = [
    '# Personalia',
    '',
    '## Identity',
    '',
    `- Name: ${agentName}`,
    `- Owner: ${ownerName}`,
    '- Role: Personal AI assistant',
    '',
    '## Capabilities',
    '',
    '- Conversational interaction via Telegram (text)',
    '- Can execute CLI commands via a whitelisted tool executor',
    '',
    '## Limitations',
    '',
    '- Cannot make phone calls',
    '- Cannot access websites or browse the internet',
    `- Cannot access files on ${ownerName}'s personal devices`,
    `- Always needs permission before sending messages or emails on ${ownerName}'s behalf`,
    '',
    '## History',
    '',
    `- ${new Date().toISOString().slice(0, 10)}: Initial setup`,
  ].join('\n');

  await wizardSave('identity', values);
}

async function testConnection(service, params) {
  const target = el(`test-${service}`);
  target.innerHTML = '<span style="color:var(--muted)">Testing...</span>';
  try {
    const r = await api('POST', '/setup/test-connection', { service, ...params });
    if (r.ok) {
      let msg = 'Connection successful';
      if (r.bot_username) msg += ` (@${r.bot_username})`;
      if (r.response) msg += `: ${r.response}`;
      target.innerHTML = `<div class="test-result test-ok">${msg}</div>`;
    } else {
      target.innerHTML = `<div class="test-result test-err">${r.error}</div>`;
    }
  } catch (e) {
    target.innerHTML = `<div class="test-result test-err">${e.message}</div>`;
  }
}

function generateKey() {
  const arr = new Uint8Array(24);
  crypto.getRandomValues(arr);
  el('w-admin-key').value = Array.from(arr, b => b.toString(16).padStart(2, '0')).join('');
}

async function finishSetup() {
  const target = el('start-result');
  target.innerHTML = '<span style="color:var(--muted)">Starting agent...</span>';
  try {
    const r = await api('POST', '/agent/start');
    if (r.status === 'started' || r.status === 'already_running') {
      target.innerHTML = `<div class="test-result test-ok">Agent is running. Channels: ${(r.channels || []).join(', ') || 'none'}</div>`;
      // Save the admin key for dashboard access
      const key = el('w-admin-key')?.value;
      if (key) {
        apiKey = key;
        localStorage.setItem('admin_api_key', key);
      }
      setTimeout(() => { showView('dashboard'); loadDashboard(); }, 1500);
    } else {
      target.innerHTML = `<div class="test-result test-err">${r.error || r.status}</div>`;
    }
  } catch (e) {
    target.innerHTML = `<div class="test-result test-err">${e.message}</div>`;
  }
}

// --- Auth ---
async function authenticate() {
  apiKey = el('auth-key').value;
  localStorage.setItem('admin_api_key', apiKey);
  try {
    await api('GET', '/config');
    showView('dashboard');
    loadDashboard();
  } catch {
    el('auth-error').innerHTML = '<div class="test-result test-err">Invalid API key</div>';
  }
}

// --- Dashboard ---
async function loadDashboard() {
  loadStatus();
  loadConfig();
}

async function loadStatus() {
  try {
    const s = await api('GET', '/agent/status');
    const h = await api('GET', '/health');
    const bar = el('status-bar');
    const badge = s.running ? '<span class="badge badge-ok">running</span>' : '<span class="badge badge-off">stopped</span>';
    bar.innerHTML = `${badge} <span style="color:var(--muted)">Channels: ${s.channels?.join(', ') || 'none'} | Jobs: ${s.scheduler_jobs || 0}</span>`;
  } catch {}
}

// Config
let _configData = {};

async function loadConfig() {
  try {
    _configData = await api('GET', '/config');
    renderConfig();
  } catch {}
}

function renderConfig() {
  const filter = (el('cfg-search')?.value || '').toLowerCase();
  const keys = Object.keys(_configData).sort().filter(k => !filter || k.toLowerCase().includes(filter) || (_configData[k] ?? '').toLowerCase().includes(filter));
  const table = document.createElement('table');
  table.innerHTML = '<tr><th style="min-width:250px">Key</th><th>Value</th><th></th></tr>';
  for (const k of keys) {
    const tr = document.createElement('tr');
    const tdKey = document.createElement('td');
    tdKey.textContent = k;
    const tdVal = document.createElement('td');
    tdVal.textContent = _configData[k];
    const tdActions = document.createElement('td');
    tdActions.style.whiteSpace = 'nowrap';

    const editBtn = document.createElement('button');
    editBtn.textContent = 'edit';
    editBtn.style.cssText = 'padding:2px 8px;font-size:0.75rem';
    editBtn.addEventListener('click', () => editConfig(k, _configData[k]));

    const delBtn = document.createElement('button');
    delBtn.textContent = 'x';
    delBtn.className = 'danger';
    delBtn.style.cssText = 'padding:2px 8px;font-size:0.75rem;margin-left:4px';
    delBtn.addEventListener('click', () => deleteConfig(k));

    tdActions.appendChild(editBtn);
    tdActions.appendChild(delBtn);
    tr.appendChild(tdKey);
    tr.appendChild(tdVal);
    tr.appendChild(tdActions);
    table.appendChild(tr);
  }
  el('config-table').innerHTML = '';
  el('config-table').appendChild(table);
}

function filterConfig() {
  renderConfig();
}

async function updateConfig() {
  const key = el('cfg-key').value.trim();
  const val = el('cfg-val').value;
  if (!key) return;
  try {
    const r = await api('PATCH', '/config', { values: { [key]: val } });
    el('cfg-result').innerHTML = `<div class="test-result test-ok">Updated: ${r.updated?.join(', ')}</div>`;
    el('cfg-key').value = '';
    el('cfg-val').value = '';
    el('cfg-key').readOnly = false;
    el('cfg-cancel').classList.add('hidden');
    loadConfig();
  } catch (e) {
    el('cfg-result').innerHTML = `<div class="test-result test-err">${e.message}</div>`;
  }
}

function editConfig(key, value) {
  el('cfg-key').value = key;
  el('cfg-key').readOnly = true;
  el('cfg-val').value = value;
  el('cfg-cancel').classList.remove('hidden');
  el('cfg-val').focus();
}

function cancelEditConfig() {
  el('cfg-key').value = '';
  el('cfg-key').readOnly = false;
  el('cfg-val').value = '';
  el('cfg-cancel').classList.add('hidden');
  el('cfg-result').innerHTML = '';
}

async function deleteConfig(key) {
  if (!confirm(`Delete config key "${key}"?`)) return;
  try {
    await api('DELETE', `/config/${encodeURIComponent(key)}`);
    loadConfig();
  } catch (e) {
    el('cfg-result').innerHTML = `<div class="test-result test-err">${e.message}</div>`;
  }
}

async function agentAction(action) {
  try {
    const r = await api('POST', `/agent/${action}`);
    el('agent-result').innerHTML = `<div class="test-result test-ok">${r.status}${r.channels ? ' — channels: ' + r.channels.join(', ') : ''}</div>`;
    loadStatus();
  } catch (e) {
    el('agent-result').innerHTML = `<div class="test-result test-err">${e.message}</div>`;
  }
}

// Character & Personalia
async function loadCharacter() {
  try {
    const [charData, persData] = await Promise.all([
      api('GET', '/config/character'),
      api('GET', '/config/personalia'),
    ]);
    el('char-editor').value = charData.content || '';
    el('pers-editor').value = persData.content || '';
    el('char-result').innerHTML = '';
    el('pers-result').innerHTML = '';
  } catch {}
}

async function saveCharacter() {
  try {
    await api('PUT', '/config/character', { content: el('char-editor').value });
    el('char-result').innerHTML = '<div class="test-result test-ok">Character saved</div>';
  } catch (e) {
    el('char-result').innerHTML = `<div class="test-result test-err">${e.message}</div>`;
  }
}

async function savePersonalia() {
  try {
    await api('PUT', '/config/personalia', { content: el('pers-editor').value });
    el('pers-result').innerHTML = '<div class="test-result test-ok">Personalia saved</div>';
  } catch (e) {
    el('pers-result').innerHTML = `<div class="test-result test-err">${e.message}</div>`;
  }
}

// Permissions
async function loadPermissions() {
  try {
    const data = await api('GET', '/permissions');
    const rules = data.rules || {};
    const keys = Object.keys(rules).sort();
    const table = document.createElement('table');
    table.innerHTML = '<tr><th>Pattern</th><th>Level</th><th></th></tr>';
    for (const k of keys) {
      const tr = document.createElement('tr');
      const tdPattern = document.createElement('td');
      tdPattern.textContent = k;
      const tdLevel = document.createElement('td');
      tdLevel.textContent = rules[k];
      const tdActions = document.createElement('td');
      tdActions.style.whiteSpace = 'nowrap';

      const editBtn = document.createElement('button');
      editBtn.textContent = 'edit';
      editBtn.style.cssText = 'padding:2px 8px;font-size:0.75rem';
      editBtn.addEventListener('click', () => editPermission(k, rules[k]));

      const delBtn = document.createElement('button');
      delBtn.textContent = 'x';
      delBtn.className = 'danger';
      delBtn.style.cssText = 'padding:2px 8px;font-size:0.75rem;margin-left:4px';
      delBtn.addEventListener('click', () => deletePermission(k));

      tdActions.appendChild(editBtn);
      tdActions.appendChild(delBtn);
      tr.appendChild(tdPattern);
      tr.appendChild(tdLevel);
      tr.appendChild(tdActions);
      table.appendChild(tr);
    }
    el('perm-table').innerHTML = '';
    el('perm-table').appendChild(table);
  } catch {}
}

function editPermission(pattern, level) {
  el('perm-pattern').value = pattern;
  el('perm-level').value = level;
  el('perm-level').focus();
}

async function addPermission() {
  const pattern = el('perm-pattern').value.trim();
  const level = el('perm-level').value;
  if (!pattern) return;
  await api('PUT', '/permissions', { pattern, level });
  loadPermissions();
}

async function deletePermission(pattern) {
  await api('DELETE', `/permissions/${encodeURIComponent(pattern)}`);
  loadPermissions();
}

// Memory
async function loadMemory() {
  try {
    const lt = await api('GET', '/memory/long-term');
    let html = '<table><tr><th>ID</th><th>Cat</th><th>Subject</th><th>Content</th><th></th></tr>';
    for (const m of (lt.memories || [])) {
      html += `<tr><td>${m.id}</td><td>${esc(m.category)}</td><td>${esc(m.subject)}</td><td>${esc(m.content)}</td><td><button class="danger" style="padding:2px 8px;font-size:0.75rem" onclick="deleteMemory('long-term',${m.id})">x</button></td></tr>`;
    }
    html += '</table>';
    el('lt-table').innerHTML = html;
  } catch {}

  try {
    const st = await api('GET', '/memory/short-term');
    let html = '<table><tr><th>ID</th><th>Content</th><th>Expires</th><th></th></tr>';
    for (const m of (st.memories || [])) {
      html += `<tr><td>${m.id}</td><td>${esc(m.content)}</td><td>${esc(m.expires_at)}</td><td><button class="danger" style="padding:2px 8px;font-size:0.75rem" onclick="deleteMemory('short-term',${m.id})">x</button></td></tr>`;
    }
    html += '</table>';
    el('st-table').innerHTML = html;
  } catch {}
}

async function deleteMemory(tier, id) {
  await api('DELETE', `/memory/${tier}/${id}`);
  loadMemory();
}

async function triggerConsolidation() {
  try {
    const r = await api('POST', '/memory/consolidate');
    alert(`Consolidation: ${r.promoted_to_long_term || 0} promoted, ${r.expired_deleted || 0} expired deleted`);
    loadMemory();
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

// Logs
async function loadLogs() {
  try {
    const data = await api('GET', '/logs?lines=200');
    const viewer = el('log-viewer');
    viewer.textContent = (data.lines || []).join('\n');
    viewer.scrollTop = viewer.scrollHeight;
  } catch {}
}

function toggleAutoLogs() {
  if (el('log-auto').checked) {
    loadLogs();
    logInterval = setInterval(loadLogs, 3000);
  } else {
    clearInterval(logInterval);
    logInterval = null;
  }
}

// Tabs
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.dataset.tab === name));
  if (name === 'character') loadCharacter();
  if (name === 'permissions') loadPermissions();
  if (name === 'memory') loadMemory();
  if (name === 'logs') loadLogs();
}

function esc(s) { const d = document.createElement('div'); d.textContent = s ?? ''; return d.innerHTML; }

// Allow Tab key in textareas for markdown editing
document.addEventListener('keydown', function(e) {
  if (e.key === 'Tab' && e.target.tagName === 'TEXTAREA') {
    e.preventDefault();
    const ta = e.target;
    const start = ta.selectionStart;
    const end = ta.selectionEnd;
    ta.value = ta.value.substring(0, start) + '  ' + ta.value.substring(end);
    ta.selectionStart = ta.selectionEnd = start + 2;
  }
});

init();
</script>
</body>
</html>
